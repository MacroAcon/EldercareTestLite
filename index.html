<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Eldercare Essentials Lite (v4.3 - Multi-Profile)</title>
  
  
  <style>
    :root {
      /* Colour palette */
      --ink: #0b1220;
      --muted: #374151; /* Updated for WCAG AA contrast - passes 4.5:1 on both white and light backgrounds */
      --accent: #0e7490;
      --success: #059669;
      --danger: #b91c1c;
      --line: #e5e7eb;
      --border: #e5e7eb;
      --bg: #ffffff;
      --bg-accent-light: #f0f9ff;
      --bg-accent-lighter: #f8fafc;
      /* Font scale */
      --font-scale: 1.125;
      /* Sidebar width */
      --sidebar-width: 180px;
    }
    * {
      box-sizing: border-box;
    }
    html {
        scroll-behavior: smooth;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      line-height: 1.4;
      background-color: var(--bg);
      color: var(--ink);
      font-size: calc(16px * var(--font-scale));
    }
    #main-app {
      padding-left: var(--sidebar-width);
    }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }
    /* Accessibility: Reduced Motion Support */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }

    /* --- Sidebar Styles --- */
    #sidebar-nav {
        position: fixed;
        left: 0;
        top: 0;
        height: 100vh;
        width: var(--sidebar-width);
        background-color: var(--bg-accent-lighter);
        border-right: 1px solid var(--line);
        padding: 1rem;
        overflow-y: auto;
        transition: opacity 0.3s ease;
    }
    #sidebar-nav h3 {
        font-size: 1rem;
        margin: 0 0 0.75rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #sidebar-nav ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .nav-header {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--muted);
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
        padding: 0 0.5rem;
    }
    #sidebar-nav ul li:first-child.nav-header {
        margin-top: 0;
    }
    #sidebar-nav li a {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.4rem 0.5rem;
        color: var(--ink);
        text-decoration: none;
        font-size: 0.9rem;
        border-radius: 4px;
        margin-bottom: 0.25rem;
    }
    #sidebar-nav li a:hover {
        background-color: var(--bg-accent-light);
        color: var(--accent);
    }
    .completion-indicator {
        color: var(--success);
        font-weight: bold;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }
    .completion-indicator.complete {
        opacity: 1;
    }
    /* --- End Sidebar Styles --- */

    /* --- General Styles --- */
    h1 { font-size: calc(32px * var(--font-scale)); margin: 0 0 0.5rem; color: var(--ink); }
    h2 { font-size: calc(24px * var(--font-scale)); margin: 1.5rem 0 0.5rem; color: var(--ink); border-bottom: 1px solid var(--line); padding-bottom: 0.25rem; scroll-margin-top: 1rem; }
    h3 { font-size: calc(20px * var(--font-scale)); margin: 1rem 0 0.25rem; color: var(--ink); }
    label { display: block; font-weight: 600; margin-bottom: 0.25rem; }
    input[type="text"], input[type="tel"], input[type="date"], textarea, select { width: 100%; padding: 0.5rem; border: 1px solid var(--line); border-radius: 4px; font-size: 1rem; color: var(--ink); background-color: white; }
    input.invalid, textarea.invalid, select.invalid { border-color: var(--danger); }
    textarea { resize: vertical; min-height: 4rem; }
    .field { margin-bottom: 1rem; }
    .error { color: var(--danger); font-size: 0.875rem; margin-top: 0.25rem; }
    button { font-size: 1rem; padding: 0.75rem 1.25rem; margin: 0.25rem 0.25rem 0.25rem 0; border: 1px solid var(--accent); background-color: #ffffff; color: var(--accent); border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
    button:hover { background-color: var(--bg-accent-lighter); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button.primary { background-color: var(--accent); color: white; }
    button.primary:hover { background-color: #0c5970; }
    button.danger { border-color: var(--danger); color: var(--danger); }
    button.danger:hover { background-color: #fef2f2; }
    button.secondary { border-color: var(--muted); color: var(--muted); }
    button.secondary:hover { background-color: #f3f4f6; }
    button.add-item-btn { background-color: var(--success); color: white; border-color: var(--success); padding: 0.75rem 1.5rem; font-size: 1.1rem; }
    button.add-item-btn:hover { background-color: #047857; }
    button.link-btn { background: none; border: none; color: var(--accent); text-decoration: underline; padding: 0; margin: 0; font-size: inherit; cursor: pointer; }
    .list-item-actions button { font-size: 1rem; padding: 0.5rem 0.75rem; margin: 0 0 0 0.5rem; min-height: 2.5rem; }
    button:focus, input:focus, textarea:focus, select:focus { outline: 3px solid var(--accent); outline-offset: 4px; }
    .section { padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 1px solid var(--line); transition: all 0.3s ease; }
    #disclaimer { font-size: 0.875rem; color: var(--muted); margin-bottom: 1rem; }
    .helper { font-size: 0.875rem; color: var(--muted); margin-top: 0.25rem; }
    .helper-instructions {
      font-size: 0.9rem;
      color: var(--muted);
      background-color: var(--bg-accent-lighter);
      border: 1px solid var(--line);
      border-radius: 6px;
      padding: 1rem;
      line-height: 1.5;
      margin-top: 0.5rem;
      margin-bottom: 1.5rem;
    }
    .helper-instructions strong {
      color: var(--ink);
    }
    .helper-instructions ol {
      padding-left: 1.5rem;
      margin: 0.5rem 0;
    }
    .live-region { position: absolute; left: -9999px; width: 1px; height: 1px; overflow: hidden; }
    .list-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background-color: var(--bg-accent-lighter); border: 1px solid var(--line); border-radius: 4px; margin-bottom: 0.75rem; }
    .list-item-content { flex-grow: 1; }
    .list-item-actions { flex-shrink: 0; margin-left: 1rem; }
    .list-item p { margin: 0 0 0.25rem; }
    .list-item .item-title { font-weight: 600; color: var(--ink); }
    .list-item .item-detail { font-size: 0.9rem; color: var(--muted); }
    .structured-form { padding: 1rem; background-color: #fdfdfd; border: 1px solid var(--line); border-radius: 4px; margin-bottom: 1rem; }
    .form-row { display: flex; gap: 1rem; align-items: flex-end; }
    .form-row .field { flex: 1; }
    details { border: 1px solid var(--line); border-radius: 4px; padding: 0.5rem; margin-top: 1rem; }
    details summary { font-weight: 600; cursor: pointer; }
    .micro-tip { font-style: italic; color: var(--muted); background-color: var(--bg-accent-lighter); padding: 0.75rem; border-radius: 4px; margin-top: 0; }
    .phone-cell a { text-decoration: none; color: var(--ink); }
    .phone-cell .copy-btn { font-size: 0.75rem; padding: 0.1rem 0.3rem; margin-left: 0.5rem; border-color: var(--muted); color: var(--muted); }
    fieldset { border: none; padding: 0; margin: 0; }
    .structured-list-section { margin-top: 2rem; }
    
    .empty-state-enhanced {
      text-align: center;
      padding: 3rem 2rem;
      border: 2px dashed var(--line);
      border-radius: 12px;
      background-color: var(--bg-accent-lighter);
      margin: 1rem 0;
    }
    .empty-state-enhanced .empty-state-icon { 
      font-size: 4rem; 
      margin-bottom: 1.5rem; 
      display: block;
      line-height: 1;
    }
    .empty-state-enhanced h3 { 
      margin-top: 0; 
      font-size: 1.5rem;
      color: var(--ink);
      margin-bottom: 1rem;
    }
    .empty-state-enhanced p { 
      color: var(--muted); 
      margin-bottom: 1.5rem; 
      font-size: 1.1rem;
      line-height: 1.4;
    }
    .empty-state-enhanced .empty-state-benefits { 
      list-style: none; 
      padding: 0; 
      margin: 2rem 0; 
      text-align: left; 
      max-width: 350px; 
      margin-left: auto; 
      margin-right: auto; 
    }
    .empty-state-enhanced .empty-state-benefits li { 
      position: relative; 
      padding-left: 2rem; 
      margin-bottom: 0.75rem; 
      font-size: 1rem;
      line-height: 1.4;
    }
    .empty-state-enhanced .empty-state-benefits li::before { 
      content: '✓'; 
      color: var(--success); 
      position: absolute; 
      left: 0; 
      font-size: 1.2rem;
      font-weight: bold;
    }
    .list-display:not(:empty) + .empty-state-enhanced { display: none; }


    
    /* --- Validation success indicator (Tier 2 UX) --- */
    /* Apply to input and select; not textarea */
    input.valid, select.valid {
      border-color: var(--success);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23059669' stroke-width='3'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 44px;
    }
    /* Ensure invalid styling always wins if both are present */
    input.invalid, select.invalid {
      border-color: var(--danger) !important;
      background-image: none !important;
    }
/* --- Focus Mode --- */
    body.focus-mode #sidebar-nav { opacity: .7; }
    .section[data-collapsed="1"] { max-height: 4.5rem; overflow: hidden; padding-top: 0; padding-bottom: 0; margin-bottom: 0; border-bottom-width: 0; }
    .section[data-collapsed="1"] > *:not(h2) { display: none; }
    body.focus-mode h2 { padding-top: .5rem; cursor: pointer;}

/* --- Accessibility Modes --- */
    /* Large Text Mode */
    body.large-text {
      --font-scale: 1.5;
    }
    
    /* High Contrast Mode */
    body.high-contrast {
      /* Override main palette variables */
      --ink: #000000;
      --muted: #333333;
      --bg: #ffffff;
      --line: #000000;
      --border: #000000;
      --accent: #0000ff;
      --success: #008000;
      --danger: #ff0000;
      --bg-accent-light: #e6e6ff;
      --bg-accent-lighter: #f0f0f0;
      
      /* Legacy variables for explicit overrides */
      --text: #000000;
      --text-muted: #333333;
      --background: #ffffff;
      --primary: #0000ff;
      --primary-hover: #0000cc;
      --secondary: #666666;
      --secondary-hover: #333333;
      --warning: #ff8c00;
      --info: #0000ff;
    }


    /* --- Save Status Indicator --- */
    #save-status {
        font-size: 0.8rem;
        color: var(--success);
        font-weight: bold;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
    }
    #save-status.visible {
        opacity: 1;
    }

    /* --- Toast Notification --- */
    .toast {
        position: fixed;
        bottom: -100px;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--ink);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: bottom 0.5s ease-in-out;
        z-index: 1000;
        max-width: 90%;
    }
    .toast.show {
        bottom: 20px;
    }
    .toast button {
        background: transparent;
        border: 1px solid var(--accent);
        color: var(--accent);
        font-weight: bold;
        white-space: nowrap;
    }
    #toast-container { position: fixed; z-index: 1001; }

    /* --- Modals (Edit & Emergency) --- */
    .modal-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(0,0,0,0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999;
    }
    .modal-overlay.visible {
        display: flex;
    }
    .modal-content {
        background-color: white;
        padding: 1.5rem;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .modal-content h3 {
        margin-top: 0;
    }
    #edit-modal-actions {
        margin-top: 1.5rem;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }
    #edit-modal-actions button.danger {
        margin-right: auto;
    }

    /* --- Emergency FAB & Modal --- */
    .fab-emergency {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: var(--danger);
      color: white;
      border: none;
      font-size: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      cursor: pointer;
      z-index: 900;
    }
    .emergency-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0; }
    .emergency-card { background-color: var(--bg-accent-lighter); padding: 1rem; border-radius: 8px; border: 1px solid var(--line); }
    .emergency-card h3 { margin: 0 0 0.5rem; font-size: 1rem; color: var(--muted); }
    .emergency-value { font-size: 1.2rem; font-weight: bold; margin: 0; }
    .code-status-large { color: var(--danger); font-size: 1.5rem; }
    .emergency-link { font-size: 1.2rem; font-weight: bold; text-decoration: none; color: var(--accent); }


    /* --- Read-only "Caregiver" Mode --- */
    body.readonly .add-control,
    body.readonly .list-item-actions,
    body.readonly .data-management-actions,
    body.readonly #btn-clear,
    body.readonly #btn-sample,
    body.readonly #btn-restart,
    body.readonly #visit-notes-actions button {
        display: none !important;
    }
    body.readonly input,
    body.readonly textarea {
        background-color: var(--bg-accent-lighter);
        color: var(--muted);
        pointer-events: none;
    }
    body.readonly select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        pointer-events: none;
    }

    #visit {
        background-color: var(--bg-accent-lighter);
        border: 1px solid var(--line);
        padding: 1rem;
        border-radius: 8px;
    }
    
    /* --- Onboarding Styles --- */
    body.onboarding-active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .onboarding-container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 600px;
      width: 100%;
      overflow: hidden;
    }
    .onboarding-container .step {
      display: none;
      padding: 40px;
      animation: fadeIn 0.4s ease;
    }
    .onboarding-container .step.active { display: block; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .progress-bar {
      height: 4px;
      background: #e5e7eb;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.3s ease;
      width: 0%;
    }
    .onboarding-container h1 { font-size: 28px; color: #1f2937; margin-bottom: 12px; }
    .onboarding-container .subtitle { color: #6b7280; font-size: 16px; margin-bottom: 32px; line-height: 1.5; }
    .onboarding-container .icon-large { font-size: 64px; text-align: center; margin-bottom: 24px; }
    .feature-list { list-style: none; margin: 24px 0; padding: 0; }
    .feature-list li { padding: 12px 0; display: flex; align-items: flex-start; gap: 12px; }
    .feature-list li::before { content: "✓"; color: #10b981; font-weight: bold; font-size: 20px; flex-shrink: 0; }
    .form-group { margin-bottom: 20px; }
    .onboarding-container label { font-weight: 600; color: #374151; margin-bottom: 8px; font-size: 14px; }
    .required { color: #ef4444; }
    .onboarding-container input, .onboarding-container select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.2s;
    }
    .onboarding-container input:focus, .onboarding-container select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .onboarding-container input.valid {
      border-color: #10b981;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2310b981' stroke-width='3'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 44px;
    }
    .onboarding-container input.invalid { border-color: #ef4444; }
    .onboarding-container .helper-text { font-size: 13px; color: #6b7280; margin-top: 6px; }
    .onboarding-container .error-text { font-size: 13px; color: #ef4444; margin-top: 6px; display: none; }
    .onboarding-container input.invalid + .error-text { display: block; }
    .button-group { display: flex; gap: 12px; margin-top: 32px; }
    .onboarding-container button { padding: 14px 28px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
    .onboarding-container .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; flex: 1; border: none; }
    .onboarding-container .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
    .onboarding-container .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .onboarding-container .btn-secondary { background: white; color: #667eea; border: 2px solid #667eea; }
    .onboarding-container .btn-secondary:hover { background: #f3f4f6; }
    .success-icon { width: 80px; height: 80px; margin: 0 auto 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; color: white; animation: scaleIn 0.5s ease; }
    @keyframes scaleIn { from { transform: scale(0); } to { transform: scale(1); } }
    .privacy-badge { display: inline-flex; align-items: center; gap: 8px; background: #f0fdf4; color: #166534; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 500; margin: 24px 0; }

    @media (max-width: 768px) {
        #main-app { padding-left: 0; }
        #sidebar-nav { position: static; width: 100%; height: auto; border-right: none; border-bottom: 1px solid var(--line); margin-bottom: 1rem; }
        #sidebar-nav ul { display: flex; flex-wrap: wrap; }
        #sidebar-nav li a { padding: 0.5rem; margin-right: 0.5rem; }
        .form-row { flex-direction: column; align-items: stretch; }
        .onboarding-container { border-radius: 0; }
        .onboarding-container .step { padding: 24px; }
        .onboarding-container h1 { font-size: 24px; }
        .button-group { flex-direction: column; }
        .onboarding-container .btn-secondary { order: 2; }
    }

    /* --- PATCH STYLES START --- */
    /* Restore banner */
    #restoreBanner { position: sticky; top: 0; z-index: 1000; padding: 10px; background: #0b6; color: #fff; box-shadow: 0 2px 6px rgba(0,0,0,.15); }
    #restoreBanner .rb-body { display: flex; gap: 12px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    #restoreBanner .rb-actions { display: flex; gap: 8px; }
    #restoreBanner button { background: #fff; color: #064; border: 1px solid #064; padding: 6px 10px; border-radius: 6px; cursor: pointer; }

    /* Print scaffolding */
    @media print { 
      .no-print { display: none !important; } 
      
      /* Prevent awkward page breaks */
      h1, h2, h3, h4, h5, h6 { 
        page-break-after: avoid; 
        break-after: avoid;
      }
      
      table, tr, td, th { 
        page-break-inside: avoid; 
        break-inside: avoid;
      }
      
      .list-item, .section { 
        page-break-inside: avoid; 
        break-inside: avoid;
      }
      
      /* Ensure proper margins and prevent clipping */
      @page {
        margin: 0.5in;
        size: letter;
      }
      
      @page :first {
        margin-top: 0.5in;
      }
      
      /* A4 support */
      @page a4 {
        margin: 1.27cm;
        size: A4;
      }
      
      @page a4 :first {
        margin-top: 1.27cm;
      }
      
      /* Ensure content fits within margins */
      body {
        margin: 0;
        padding: 0;
        font-size: 12pt;
        line-height: 1.4;
        color: #000;
        background: #fff;
      }
      
      /* Hide any remaining UI elements */
      nav, header, footer, aside, 
      .sidebar, .navigation, .menu,
      button, .button, input, select, textarea,
      .modal, .overlay, .popup, .tooltip {
        display: none !important;
      }
      
      /* Quick print emergency sheet styles */
      .quick-print-emergency {
        font-size: 18px !important;
        line-height: 1.4 !important;
        color: #000 !important;
        background: #fff !important;
      }
      
      .quick-print-emergency h1 {
        font-size: 28px !important;
        font-weight: bold !important;
        text-align: center !important;
        margin-bottom: 20px !important;
        border-bottom: 3px solid #000 !important;
        padding-bottom: 10px !important;
      }
      
      .quick-print-emergency h2 {
        font-size: 22px !important;
        font-weight: bold !important;
        margin: 20px 0 10px 0 !important;
        background: #f0f0f0 !important;
        padding: 8px !important;
        border-left: 4px solid #000 !important;
      }
      
      .quick-print-emergency .emergency-info {
        background: #fff !important;
        border: 2px solid #000 !important;
        padding: 15px !important;
        margin: 10px 0 !important;
        font-weight: bold !important;
      }
      
      .quick-print-emergency table {
        width: 100% !important;
        border-collapse: collapse !important;
        margin: 10px 0 !important;
      }
      
      .quick-print-emergency th,
      .quick-print-emergency td {
        border: 1px solid #000 !important;
        padding: 8px !important;
        text-align: left !important;
      }
      
      .quick-print-emergency th {
        background: #f0f0f0 !important;
        font-weight: bold !important;
      }
    }

    .print h1, .print h2, .print h3 { margin: 0 0 .15in 0; }
    .print .two-up { display: grid; grid-template-columns: 1fr 1fr; gap: 0.25in; }
    .print .card { border: 1px solid #000; padding: 0.25in; border-radius: 6px; }
    .print table { width: 100%; border-collapse: collapse; }
    .print th, .print td { border: 1px solid #000; padding: 4px 6px; vertical-align: top; text-align: left; }
    .print .muted { opacity: .8; }
    .print .small { font-size: .9em; }
    /* --- PATCH STYLES END --- */

    /* === Accessibility: Large Text & High Contrast === */
    body.large-text input,
    body.large-text select,
    body.large-text textarea,
    body.large-text button,
    body.large-text label,
    body.large-text .help,
    body.large-text .cell,
    body.large-text .pill,
    body.large-text .badge {
      font-size: 1.125em; /* bump controls too */
    }
    body.large-text h1 { font-size: calc(32px * var(--font-scale)); }
    body.large-text h2 { font-size: calc(24px * var(--font-scale)); }
    body.large-text h3 { font-size: calc(20px * var(--font-scale)); }

    /* Force high-contrast to override hard-coded colors */
    body.high-contrast,
    body.high-contrast * {
      color: #000 !important;
      background-color: #fff !important;
      border-color: #000 !important;
      box-shadow: none !important;
    }
    body.high-contrast a,
    body.high-contrast .link,
    body.high-contrast button {
      outline: 2px solid #000 !important;
      text-decoration: underline !important;
    }
    body.high-contrast .accent,
    body.high-contrast .btn.primary {
      background-color: #000 !important;
      color: #fff !important;
      border-color: #000 !important;
    }
  </style>
</head>
<body>

  <div class="onboarding-container" id="onboarding-container" hidden>
    <div class="progress-bar">
      <div class="progress-fill" id="progressBar"></div>
    </div>
    
    <!-- Step 1: Welcome -->
    <div class="step active" id="step1">
      <div class="icon-large">🏥</div>
      <h1>Welcome to Eldercare Essentials</h1>
      <p class="subtitle">
        A simple, secure way to organize critical health information for yourself or a loved one.
        Perfect for emergencies, doctor visits, and coordinating care.
      </p>
      
      <ul class="feature-list">
        <li>
          <div>
            <strong>Always accessible</strong><br>
            <span class="helper-text">Works offline, no account required</span>
          </div>
        </li>
        <li>
          <div>
            <strong>Privacy first</strong><br>
            <span class="helper-text">Your data never leaves your device</span>
          </div>
        </li>
        <li>
          <div>
            <strong>Emergency ready</strong><br>
            <span class="helper-text">Generate printable sheets for first responders</span>
          </div>
        </li>
        <li>
          <div>
            <strong>Caregiver friendly</strong><br>
            <span class="helper-text">Use read-only mode to share info safely</span>
          </div>
        </li>
      </ul>
      
      <div class="privacy-badge">
        🔒 100% Private - No server, no tracking
      </div>
      
      <div class="button-group">
        <button class="btn-secondary" id="onboarding-skip" type="button">Skip & Go to Dashboard</button>
        <button class="btn-primary" id="onboarding-step1-next">Get Started</button>
      </div>
    </div>
    
    <!-- Step 2: Basic Info -->
    <div class="step" id="step2">
      <h1>Let's start with the basics</h1>
      <p class="subtitle">
        This helps personalize your experience. All fields marked with <span class="required">*</span> are essential for emergency situations.
      </p>
      
      <form id="basicsForm">
        <div class="form-group">
          <label for="fullName">
            Full Name <span class="required">*</span>
          </label>
          <input 
            type="text" 
            id="onboarding-fullName" 
            placeholder="Patricia M. Alvarez"
            required
          >
          <span class="error-text">Please enter a full name</span>
        </div>
        
        <div class="form-group">
          <label for="dateOfBirth">
            Date of Birth <span class="required">*</span>
          </label>
          <input 
            type="date" 
            id="onboarding-dateOfBirth"
            required
          >
          <span class="helper-text">Helps medical staff provide age-appropriate care</span>
        </div>
        
        <div class="form-group">
          <label for="codeStatus">
            Code Status <span class="required">*</span>
          </label>
          <select id="onboarding-codeStatus" required>
            <option value="">-- Please select --</option>
            <option value="Full Code">Full Code (Attempt resuscitation)</option>
            <option value="DNR">DNR (Do Not Resuscitate)</option>
            <option value="Other">Other (See Advance Directive)</option>
          </select>
          <span class="helper-text">Critical for emergency responders to know your wishes</span>
        </div>
      </form>
      
      <div class="button-group">
        <button class="btn-secondary" id="onboarding-step2-back">Back</button>
        <button class="btn-primary" id="onboarding-step2-next">
          Continue
        </button>
      </div>
    </div>
    
    <!-- Step 3: Emergency Contact -->
    <div class="step" id="step3">
      <h1>Emergency Contact (ICE)</h1>
      <p class="subtitle">
        "ICE" stands for "In Case of Emergency." First responders are trained to look for this contact. Choose someone who knows your medical history.
      </p>
      
      <form id="iceForm">
        <div class="form-group">
          <label for="iceName">
            Contact Name <span class="required">*</span>
          </label>
          <input 
            type="text" 
            id="onboarding-iceName" 
            placeholder="Daniel Alvarez"
            required
          >
        </div>
        
        <div class="form-group">
          <label for="iceRelation">
            Relationship
          </label>
          <input 
            type="text" 
            id="onboarding-iceRelation" 
            placeholder="Son, Daughter, Spouse, Friend..."
          >
          <span class="helper-text">Helps staff understand the contact's role</span>
        </div>
        
        <div class="form-group">
          <label for="icePhone">
            Phone Number <span class="required">*</span>
          </label>
          <input 
            type="tel" 
            id="onboarding-icePhone" 
            placeholder="(555) 123-4567"
            required
          >
          <span class="error-text">Please enter a valid 10-digit phone number</span>
        </div>
      </form>
      
      <div class="button-group">
        <button class="btn-secondary" id="onboarding-step3-back">Back</button>
        <button class="btn-primary" id="onboarding-step3-next">
          Continue
        </button>
      </div>
    </div>
    
    <!-- Step 4: Success -->
    <div class="step" id="step4">
      <div class="success-icon">✓</div>
      <h1 style="text-align: center;">You're all set!</h1>
      <p class="subtitle" style="text-align: center;">
        You've created a basic emergency profile. You can now add medications, doctors, and other details at your own pace.
      </p>
      
      <ul class="feature-list" style="margin-top: 32px;">
        <li>
          <div>
            <strong>Next: Add a medication</strong><br>
            <span class="helper-text">Even one entry helps first responders</span>
          </div>
        </li>
        <li>
          <div>
            <strong>Then: Add your primary doctor</strong><br>
            <span class="helper-text">Critical for coordinating care</span>
          </div>
        </li>
        <li>
          <div>
            <strong>Finally: Generate your Fridge Sheet</strong><br>
            <span class="helper-text">Print and display for emergencies</span>
          </div>
        </li>
      </ul>
      
      <div class="button-group">
        <button class="btn-primary" id="onboarding-complete">
          Go to Dashboard
        </button>
      </div>
    </div>
  </div>

  <div id="main-app" hidden>
    <nav id="sidebar-nav" class="no-print" role="navigation" aria-label="Main navigation">
        <h3>
          <span>Sections</span>
          <span id="save-status">Saved ✓</span>
        </h3>
        <ul>
            <li class="nav-header">Patient Info</li>
            <li><a href="#basics">👤 Basics <span class="completion-indicator" id="ind-basics">✓</span></a></li>
            <li><a href="#contacts-ice">📞 Contacts <span class="completion-indicator" id="ind-contacts-ice">✓</span></a></li>
            <li><a href="#meds">💊 Medications <span class="completion-indicator" id="ind-meds">✓</span></a></li>
            <li><a href="#care_team">👨‍⚕️ Care Team <span class="completion-indicator" id="ind-care_team">✓</span></a></li>
            <li><a href="#contacts-other">🏥 Pharmacy & Insurance <span class="completion-indicator" id="ind-contacts-other">✓</span></a></li>
            
            <li class="nav-header">Guides &amp; Tools</li>
            <li><a href="#respite">🛟 Respite Guide</a></li>
            <li><a href="#visit">📋 Doctor Visit</a></li>

            <li class="nav-header">Actions</li>
            <li><a href="#export">📄 Generate/Save</a></li>
        </ul>
    </nav>

    <main style="max-width: 720px; margin: auto; padding: 1rem;">
      
      <div id="restoreBanner" hidden>
        <div class="rb-body">
          <strong>Saved information found.</strong>
          <span>Load it into the form?</span>
          <div class="rb-actions">
            <button type="button" id="restoreYes">Use it</button>
            <button type="button" id="restoreNo">Dismiss</button>
          </div>
        </div>
      </div>

      <header role="banner" aria-label="Application header">
        <h1>Eldercare Essentials Lite</h1>
        <p id="disclaimer" class="no-print">Informational only; not medical or legal advice. Share only what's needed. <strong>Your data never leaves your device.</strong></p>
      </header>
      
      <div id="caregiver-banner" class="no-print" style="display:none;margin:.5rem 0;padding:.5rem;border:1px solid #e5e7eb;background:#f8fafc;border-radius:6px">
        Viewing in Caregiver mode for <span id="cg-name"></span>. Editing is off.
      </div>

      <div class="no-print" style="margin:.5rem 0">
        <div style="display:flex;align-items:center;gap:1rem;">
          <label for="focus_mode_toggle" style="display:inline-flex;gap:.5rem;align-items:center;font-weight:normal; cursor: pointer;">
            <input id="focus_mode_toggle" type="checkbox" style="width:auto" />
            Focus Mode
          </label>
          <div id="overall-progress" aria-label="Overall completion" style="flex:1;height:6px;background:#e5e7eb;border-radius:4px;overflow:hidden">
            <div id="overall-progress-bar" style="height:100%;width:0%;background:#0e7490;transition:width 0.5s ease;"></div>
          </div>
        </div>
        
        <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
          <h4 style="margin: 0 0 0.75rem 0; font-size: 1rem; color: #495057;">Accessibility Options</h4>
          <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            <label for="large_text_toggle" style="display:inline-flex;gap:.5rem;align-items:center;font-weight:normal; cursor: pointer;">
              <input id="large_text_toggle" type="checkbox" style="width:auto" />
              Large Text Mode
            </label>
            <label for="high_contrast_toggle" style="display:inline-flex;gap:.5rem;align-items:center;font-weight:normal; cursor: pointer;">
              <input id="high_contrast_toggle" type="checkbox" style="width:auto" />
              High Contrast Mode
            </label>
          </div>
        </div>
        <p class="helper no-print" style="margin-top:0.25rem; margin-bottom: 1rem;">When enabled, Focus Mode collapses other sections so you can concentrate on one at a time.</p>
      </div>

      <div class="no-print structured-form" id="quick-start">
        <strong>Quick start</strong>
        <p class="helper" style="margin-top:0;">Complete these first few steps to create a basic emergency profile.</p>
        <ol style="margin:.5rem 0 0 1rem; padding-left: 1rem;">
          <li>Add an Emergency Contact (ICE)</li>
          <li>Add 1 medication you use daily</li>
          <li>Add your primary doctor</li>
        </ol>
        <div style="margin-top:.5rem">
          <button type="button" class="primary" onclick="document.querySelector('#contacts-ice').scrollIntoView({behavior:'smooth'})">Start with Emergency Contact</button>
        </div>
        <p class="helper" style="margin-top: 0.5rem; font-size: 0.8rem;">"ICE" stands for "In Case of Emergency." First responders are trained to look for this contact.</p>
      </div>
      
      <div class="section no-print">
        <div class="data-management-actions">
          <button id="btn-sample" type="button">Use Sample Data</button>
          <button id="btn-clear" type="button" class="danger">Clear All Data</button>
          <button id="btn-restart" type="button" class="danger">Start New Profile (Resets App)</button>
        </div>
        <div class="field" style="margin-top: 1rem;">
            <label for="caregiver-mode-toggle" style="display:inline-flex; align-items:center; gap: 0.5rem; font-weight: normal;">
              <input type="checkbox" id="caregiver-mode-toggle" style="width: auto;">
              Caregiver View (read-only)
            </label>
        </div>
      </div>
      
      <div id="basics" class="section" role="region" aria-labelledby="basics-header">
        <h2 id="basics-header">👤 Care Recipient &amp; Basics</h2>
        <fieldset>
          <legend class="sr-only">Basic Information</legend>
          <div class="field">
            <label for="full_name">Care recipient full name <span class="req" aria-hidden="true">*</span></label>
            <input id="full_name" type="text" autocomplete="name" aria-describedby="err_full_name" />
            <div class="error" id="err_full_name"></div>
          </div>
          <div class="form-row">
            <div class="field">
              <label for="dob">Date of Birth</label>
              <input id="dob" type="date" aria-describedby="err_dob" />
              <div class="error" id="err_dob"></div>
            </div>
            <div class="field">
              <label for="code_status">Code Status <span class="req" aria-hidden="true">*</span></label>
              <select id="code_status" aria-describedby="err_code_status">
                  <option value="">-- Please select --</option>
                  <option value="Full Code">Full Code (Attempt resuscitation)</option>
                  <option value="DNR">DNR (Do Not Resuscitate)</option>
                  <option value="Other">Other (See Advance Directive)</option>
              </select>
              <div class="error" id="err_code_status"></div>
            </div>
          </div>
          <div class="field">
            <label for="baseline_status">Patient's "Baseline" Status</label>
            <textarea id="baseline_status" rows="3"></textarea>
            <div class="helper">Describe their "normal" state: cognitive function, mood, and physical abilities. Critical for ER staff.</div>
          </div>
          <div class="field">
            <label for="preferred_hospital">Preferred hospital</label>
            <input id="preferred_hospital" type="text" />
          </div>
        </fieldset>

        <fieldset class="structured-list-section">
            <legend><h3>Major Conditions</h3></legend>
            <div id="conditions-list-display">
                <div class="empty-state-enhanced">
                  <div class="empty-state-icon">🩺</div>
                  <h3>No Major Conditions Listed</h3>
                  <p>Listing conditions like Hypertension or Diabetes is vital for emergency care.</p>
                  <button type="button" class="primary" onclick="document.getElementById('condition_input').focus()">Add First Condition</button>
                </div>
            </div>
            <div class="add-control form-row">
                <div class="field" style="flex-grow: 1;">
                    <label for="condition_input" class="sr-only">New Condition</label>
                    <input id="condition_input" type="text" placeholder="e.g., Hypertension">
                </div>
                <button type="button" id="btn-add-condition" class="add-item-btn">Add Condition</button>
            </div>
        </fieldset>

        <fieldset class="structured-list-section">
            <legend><h3>Allergies</h3></legend>
            <div id="allergies-list-display">
              <div class="empty-state-enhanced">
                  <div class="empty-state-icon">⚠️</div>
                  <h3>No Allergies Listed</h3>
                  <p>Include drug, food, and environmental allergies to prevent dangerous reactions.</p>
                  <button type="button" class="primary" onclick="document.getElementById('allergy_input').focus()">Add First Allergy</button>
                </div>
            </div>
            <div class="add-control form-row">
                <div class="field" style="flex-grow: 1;">
                    <label for="allergy_input" class="sr-only">New Allergy</label>
                    <input id="allergy_input" type="text" placeholder="e.g., Penicillin - anaphylaxis">
                </div>
                <button type="button" id="btn-add-allergy" class="add-item-btn">Add Allergy</button>
            </div>
        </fieldset>
      </div>

      <div id="contacts-ice" class="section" role="region" aria-labelledby="contacts-ice-header">
          <h2 id="contacts-header">📞 Emergency &amp; Key Contacts</h2>
          <div class="form-row">
              <div class="field">
                  <label for="ice_name">Emergency Contact (In Case of Emergency) Name <span class="req" aria-hidden="true">*</span></label>
                  <input id="ice_name" type="text" aria-describedby="err_ice_name" />
                  <div class="error" id="err_ice_name"></div>
              </div>
              <div class="field">
                  <label for="ice_phone">Emergency Contact (ICE) Phone <span class="req" aria-hidden="true">*</span></label>
                  <input id="ice_phone" type="tel" placeholder="(773) 555-1042" aria-describedby="err_ice_phone" />
                  <div class="error" id="err_ice_phone"></div>
                  <div id="ice_phone_display" class="phone-cell"></div>
              </div>
          </div>
          <div class="field">
              <label for="primary_physician_name">Primary Care Physician (PCP) Name</label>
              <input id="primary_physician_name" type="text" />
          </div>
          <div class="field">
              <label for="primary_physician_phone">Primary Care Physician (PCP) Phone</label>
              <input id="primary_physician_phone" type="tel" placeholder="(312) 555-0186" aria-describedby="err_primary_physician_phone" />
               <div class="error" id="err_primary_physician_phone"></div>
              <div id="primary_physician_phone_display" class="phone-cell"></div>
          </div>
           <div class="field">
              <label for="address">Home address</label>
              <textarea id="address" rows="2"></textarea>
           </div>
      </div>
      
      <div id="meds" class="section" role="region" aria-labelledby="meds-header">
        <h2 id="meds-header">💊 Medications</h2>
        <div id="meds-list-display">
          <div class="empty-state-enhanced">
            <div class="empty-state-icon">💊</div>
            <h3>No medications yet</h3>
            <p>Tracking medications helps:</p>
            <ul class="empty-state-benefits">
              <li>First responders avoid dangerous drug interactions</li>
              <li>Doctors see your complete treatment picture</li>
              <li>Caregivers manage refills and schedules</li>
            </ul>
            <button type="button" class="primary" onclick="document.querySelector('#meds details').open = true; document.getElementById('med_name').focus()">Add Your First Medication</button>
            <p class="helper" style="margin-top: 1rem; font-size: 0.8rem;">💡 Tip: Include vitamins and over-the-counter meds too</p>
          </div>
        </div>
        <details class="add-control no-print">
          <summary><h3>Add a New Medication</h3></summary>
          <div class="structured-form">
            <div class="form-row">
              <div class="field" style="flex: 2;">
                  <label for="med_name">Medication Name</label>
                  <input id="med_name" type="text" />
              </div>
              <div class="field">
                  <label for="med_dose">Dosage / Strength</label>
                  <input id="med_dose" type="text" placeholder="e.g., 10 mg" />
              </div>
            </div>
            <div class="form-row">
              <div class="field">
                  <label for="med_form">Form</label>
                  <select id="med_form">
                      <option value="Tablet">Tablet / Capsule</option>
                      <option value="Inhaler">Inhaler</option>
                      <option value="Patch">Patch</option>
                      <option value="Drops">Drops (Eye/Ear)</option>
                      <option value="Liquid">Liquid</option>
                      <option value="Injection">Injection</option>
                      <option value="Other">Other</option>
                  </select>
              </div>
              <div class="field">
                  <label for="med_freq">Frequency / Schedule</label>
                  <input id="med_freq" type="text" placeholder="e.g., Once daily at night" />
              </div>
            </div>
            <div class="field">
              <label for="med_purpose">Purpose / Indication</label>
              <input id="med_purpose" type="text" placeholder="e.g., Blood pressure" />
            </div>
            <div class="field">
              <label for="med_prescriber">Prescribing Doctor (Optional)</label>
              <input id="med_prescriber" type="text" />
            </div>
            
            <div class="field" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input id="med_reminder_enabled" type="checkbox" />
                <span>Set daily reminder for this medication</span>
              </label>
              <div id="med_reminder_time_container" style="margin-top: 0.5rem; display: none;">
                <label for="med_reminder_time">Reminder time:</label>
                <input id="med_reminder_time" type="time" style="margin-left: 0.5rem;" />
                <button type="button" id="btn-export-ics" class="secondary" style="margin-left: 0.5rem; font-size: 0.8rem; padding: 0.2rem 0.5rem; display: none;" title="Download reminder as Calendar file (.ics)">Export .ics</button>
              </div>
            </div>
            
            <button id="btn-add-med" type="button" class="add-item-btn">Add Medication</button>
            <div class="helper" style="margin-top: 0.5rem;"><strong>Don't forget:</strong> Add vitamins, supplements, herbal remedies, and over-the-counter meds (like Aspirin).</div>
          </div>
        </details>
      </div>

      <div id="care_team" class="section" role="region" aria-labelledby="care_team-header">
        <h2 id="care-team-header">👨‍⚕️ Care Team (Specialists)</h2>
        <div id="docs-list-display">
            <div class="empty-state-enhanced">
              <div class="empty-state-icon">👨‍⚕️</div>
              <h3>No doctors or specialists yet</h3>
              <p>Adding care team members helps everyone stay coordinated.</p>
              <button type="button" class="primary" onclick="document.querySelector('#care_team details').open = true; document.getElementById('doc_name').focus()">Add First Care Provider</button>
            </div>
        </div>
        <details class="add-control no-print">
          <summary><h3>Add a Doctor / Specialist</h3></summary>
          <div class="structured-form">
            <div class="form-row">
                <div class="field">
                    <label for="doc_name">Doctor's Name</label>
                    <input id="doc_name" type="text" />
                </div>
                <div class="field">
                    <label for="doc_specialty">Specialty</label>
                    <input id="doc_specialty" type="text" placeholder="e.g., Cardiologist" />
                </div>
            </div>
            <div class="form-row">
                <div class="field">
                    <label for="doc_phone">Phone</label>
                    <input id="doc_phone" type="tel" />
                </div>
                <div class="field">
                    <label for="doc_role">Role in Care</label>
                    <input id="doc_role" type="text" placeholder="e.g., Manages kidney disease" />
                </div>
            </div>
            <button id="btn-add-doc" type="button" class="add-item-btn">Add Doctor</button>
          </div>
        </details>
      </div>
      
      <div id="contacts-other" class="section" role="region" aria-labelledby="contacts-other-header">
        <h2 id="pharmacy-header">🏥 Pharmacy &amp; Insurance</h2>
         <div class="form-row">
          <div class="field">
              <label for="pharmacy_name">Pharmacy name</label>
              <input id="pharmacy_name" type="text" />
          </div>
          <div class="field">
              <label for="pharmacy_phone">Pharmacy phone</label>
              <input id="pharmacy_phone" type="tel" aria-describedby="err_pharmacy_phone" />
              <div class="error" id="err_pharmacy_phone"></div>
              <div id="pharmacy_phone_display" class="phone-cell"></div>
          </div>
        </div>
        <div class="form-row">
          <div class="field">
              <label for="insurance_provider">Insurance provider</label>
              <input id="insurance_provider" type="text" />
          </div>
          <div class="field">
              <label for="policy_number">Policy or Member ID</label>
              <input id="policy_number" type="text" />
          </div>
        </div>
        <details class="no-print">
          <summary>Optional Insurance &amp; Pharmacy Details</summary>
          <div class="form-row" style="margin-top: 1rem;">
            <div class="field">
              <label for="insurance_phone">Insurance Member Services Phone</label>
              <input id="insurance_phone" type="tel" />
               <div class="error" id="err_insurance_phone"></div>
               <div id="insurance_phone_display" class="phone-cell"></div>
            </div>
            <div class="field">
              <label for="insurance_group">Group Number</label>
              <input id="insurance_group" type="text" />
            </div>
          </div>
          <div class="form-row">
             <div class="field">
              <label for="insurance_rx_bin">Rx BIN</label>
              <input id="insurance_rx_bin" type="text" />
              <p class="helper" style="margin-top:0">Usually found on your insurance card.</p>
            </div>
             <div class="field">
              <label for="insurance_rx_pcn">Rx PCN</label>
              <input id="insurance_rx_pcn" type="text" />
            </div>
          </div>
          <div class="field">
            <label for="insurance_auth_phone">Prior Authorization Phone</label>
            <input id="insurance_auth_phone" type="tel" />
            <div id="insurance_auth_phone_display" class="phone-cell"></div>
          </div>
          <div class="form-row">
            <div class="field">
              <label for="policyholder_name">Policyholder Name</label>
              <input id="policyholder_name" type="text" />
            </div>
            <div class="field">
              <label for="policyholder_rel">Relationship to Patient</label>
              <input id="policyholder_rel" type="text" />
            </div>
          </div>
           <div class="field">
            <label for="pharmacy_after_hours_phone">Pharmacy After-Hours Phone</label>
            <input id="pharmacy_after_hours_phone" type="tel" />
            <div id="pharmacy_after_hours_phone_display" class="phone-cell"></div>
          </div>
          <div class="field">
            <label for="pharmacy_mail_order">Mail-Order Pharmacy Name</label>
            <input id="pharmacy_mail_order" type="text" />
          </div>
           <div class="field">
            <label for="pharmacy_mail_order_phone">Mail-Order Pharmacy Phone</label>
            <input id="pharmacy_mail_order_phone" type="tel" />
             <div id="pharmacy_mail_order_phone_display" class="phone-cell"></div>
          </div>
        </details>
      </div>
      
      <div id="respite" class="section">
        <h2 id="respite-header">🛟 Respite Handoff Guide</h2>
        <p class="helper no-print">Fill this out to help a temporary caregiver or family member. Focus on routines and preferences to ensure safety and comfort.</p>
        <div class="field">
          <label for="respite_routine">Daily Routine</label>
          <textarea id="respite_routine" rows="3" placeholder="e.g., Morning: Wakes at 7 AM, needs help to bathroom, coffee with 1 sugar... Evening: Likes to watch news at 6 PM..."></textarea>
        </div>
        <div class="field">
          <label for="respite_prefs">Preferences &amp; Comfort Items</label>
          <textarea id="respite_prefs" rows="3" placeholder="e.g., Favorite foods (no spicy), likes classical music, always uses the blue blanket..."></textarea>
        </div>
        <div class="field">
          <label for="respite_behavior">Behavioral Triggers &amp; Calming Strategies</label>
          <textarea id="respite_behavior" rows="3" placeholder="e.g., Gets anxious if it's too loud. Calms down when listening to the radio or looking at family photos."></textarea>
        </div>
        <div class="field">
          <label for="respite_comm">Communication Tips</label>
          <textarea id="respite_comm" rows="3" placeholder="e.g., Hard of hearing in left ear. Speak clearly and face-to-face. Uses a whiteboard for complex questions."></textarea>
        </div>
        <div class="field">
          <label for="respite_practical">Practical Care Needs</label>
          <textarea id="respite_practical" rows="3" placeholder="e.g., Needs help cutting food. Uses a walker to get to bathroom. Incontinence supplies are in the closet."></textarea>
        </div>
      </div>

      <div id="visit" class="section">
          <h2 id="visit-prep-header">📋 Doctor Visit</h2>
          <p class="helper no-print">Use this section before and during the appointment. The generated PDF is cleared after saving, preparing it for the next visit.</p>
          
          <div style="border-bottom: 1px dashed var(--line); padding-bottom: 1rem; margin-bottom: 1rem;">
              <h3 style="margin-top: 0;">Before the Visit</h3>
              <div class="field">
                  <label for="visit_reason">Visit Reason</label>
                  <input id="visit_reason" type="text" placeholder="e.g., Annual check-up, follow-up for blood pressure"/>
              </div>
              <div class="field">
                  <label for="symptoms">Current Symptoms</label>
                  <textarea id="symptoms" rows="3" placeholder="e.g., Occasional dizziness, mild ankle swelling"></textarea>
              </div>
              <div class="field">
                  <label for="questions">Questions for the Doctor</label>
                  <textarea id="questions" rows="4" placeholder="List your questions before the visit."></textarea>
              </div>
          </div>

          <div>
              <h3>During &amp; After the Visit</h3>
              <div class="field">
                  <label for="visit_changes">Changes Made Today</label>
                  <textarea id="visit_changes" rows="3" placeholder="e.g., Lisinopril increased to 20mg, scheduled a follow-up..."></textarea>
              </div>
              <div class="field">
                  <label for="visit_notes">Answers &amp; Additional Notes</label>
                  <textarea id="visit_notes" rows="3" placeholder="Jot down answers to your questions and any other notes here."></textarea>
              </div>
          </div>
          <div id="visit-notes-actions" class="no-print">
              <button id="btn-finish-visit" type="button" class="primary">Record Visit &amp; Generate PDF</button>
              <button id="btn-clear-visit" type="button" class="secondary">Clear Visit Info</button>
              <p class="helper" style="margin-top: 0.5rem;">This adds a timestamp to your notes and downloads the "Doctor Visit Sheet" PDF.</p>
          </div>
      </div>

      <div id="export" class="section no-print">
        <h2 id="export-header">📄 Generate &amp; Download</h2>
        <p class="helper">Click to generate a single, print-ready PDF. We recommend generating the Fridge Sheet and Wallet Card first.</p>
        
        <div class="field" style="max-width: 200px;">
          <label for="font_size">PDF font size</label>
          <select id="font_size">
            <option value="small">Small 100%</option>
            <option value="default" selected>Default 112.5%</option>
            <option value="large">Large 125%</option>
          </select>
        </div>
        <div class="field" style="max-width: 200px;">
          <label for="paper_size">PDF paper size</label>
          <select id="paper_size">
            <option value="letter">Letter (US & Canada)</option>
            <option value="a4">A4 (International)</option>
          </select>
        </div>

        <div>
          <button id="btn-quick-print" type="button" class="primary">🖨️ Print My Info</button>
          <p class="helper" style="margin-top: 0.5rem; font-size: 0.9rem;">Quick print of essential emergency information</p>
        </div>
        
        <div style="margin-top: 1.5rem;">
          <h4>Detailed PDFs</h4>
          <button id="btn-gen-fridge" type="button" data-pdf="fridge">Generate Fridge Sheet</button>
          <button id="btn-gen-wallet" type="button" data-pdf="wallet">Generate Wallet Card</button>
          <button id="btn-gen-er-packet" type="button" data-pdf="er">Generate ER Packet</button>
          <button id="btn-gen-respite" type="button" data-pdf="respite">Generate Respite Guide</button>
          <button id="btn-gen-visit-prep" type="button" data-pdf="visit">Generate Doctor Visit Sheet</button>
        </div>
        <div id="validation_summary" class="error" style="margin-top:0.5rem;"></div>

        <h3 style="margin-top: 2rem;">Manage Profiles (Save/Load)</h3>
        <div class="helper-instructions">
          <strong>How to Manage Multiple Profiles (e.g., for Mom & Dad):</strong>
          <p style="margin: 0.5rem 0;">This app only shows *one* profile at a time. To switch people, use the Download and Load buttons:</p>
          <ol>
            <li><strong>To Save a Profile:</strong> Finish entering info (e.g., for Mom). Click <strong>"Download Data File"</strong> and save it as "Moms_Profile.json".</li>
            <li><strong>To Load a Profile:</strong> Click <strong>"Load Data File"</strong> and choose another person's file (e.g., "Dads_Profile.json"). This will replace the current profile.</li>
          </ol>
          <p style="margin-top: 0.5rem;"><strong>Important:</strong> Always <strong>Download</strong> your changes to the current profile *before* you **Load** a new one!</p>
        </div>
        <div>
          <button id="btn-save" type="button">Download Data File</button>
          <button id="btn-load" type="button">Load Data File</button>
          <input id="load_input" type="file" accept="application/json" style="display:none;" />
        </div>

        <!-- Multi-Profile Support -->
        <div class="no-print" style="margin-top:1rem; display:flex; gap:.5rem; align-items:center;">
          <label for="profileSelect" class="sr-only">Active Profile</label>
          <select id="profileSelect" style="min-width:220px"></select>

          <input id="newProfileName" type="text" placeholder="New profile name" style="min-width:220px"/>
          <button id="btnCreateProfile" type="button">Create</button>
          <button id="btnDeleteProfile" type="button" class="danger">Delete</button>
        </div>
      </div>

      <div class="live-region" id="live-region" aria-live="polite"></div>
      <p id="local-save-note" class="helper no-print" style="text-align: center; margin-top: 2rem; display:none">Saved locally on this device. Your data does not leave your browser.</p>
      
      <footer style="text-align: center; margin-top: 2rem; padding: 1rem; border-top: 1px solid var(--line);" role="contentinfo" aria-label="App information and support" class="no-print">
        <div id="edition-info" style="margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--muted);">
          <!-- Edition indicator will be populated by JavaScript -->
        </div>
        <p><a href="{{GUMROAD_URL}}" target="_blank" rel="noopener">Support &amp; Pro Pack</a></p>
      </footer>
    </main>
  </div>

  <div id="toast-container" class="no-print"></div>

  <!-- Edit Modal -->
  <div id="edit-modal-overlay" class="modal-overlay no-print">
    <div id="edit-modal" class="modal-content">
        <h3 id="edit-modal-title">Edit Entry</h3>
        <div id="edit-modal-form">
            <!-- Dynamic form content will be injected here -->
        </div>
        <div id="edit-modal-actions">
            <button id="btn-remove-from-modal" type="button" class="danger">Remove</button>
            <button id="btn-cancel-edit" type="button" class="secondary">Cancel</button>
            <button id="btn-save-edit" type="button" class="primary">Save Changes</button>
        </div>
    </div>
  </div>

  <!-- Emergency Modal -->
  <button id="emergency-fab" class="fab-emergency no-print" aria-label="Emergency Quick Access">🚨</button>
  <div id="emergency-modal-overlay" class="modal-overlay no-print">
    <div id="emergency-modal" class="modal-content">
      <h2 style="margin-top:0; border:0;">Emergency Information</h2>
      <div class="emergency-grid">
        <div class="emergency-card">
          <h3>👤 ICE Contact</h3>
          <p id="emergency-ice-name" class="emergency-value">Not set</p>
          <a id="emergency-ice-phone" href="#" class="emergency-link"></a>
        </div>
        <div class="emergency-card">
          <h3>⚠️ Code Status</h3>
          <p id="emergency-code-status" class="emergency-value code-status-large">Not set</p>
        </div>
        <div class="emergency-card" style="grid-column: 1 / -1;">
          <h3>🔴 Allergies</h3>
          <p id="emergency-allergies" class="emergency-value">Not set</p>
        </div>
      </div>
      <button id="emergency-modal-close" class="secondary" style="width: 100%;">Close</button>
    </div>
  </div>
  
  <script>
    (function () {
      'use strict';
      
      const LOCAL_STORAGE_KEY = 'eldercareLiteData';
      const ONBOARDING_KEY = 'eldercareLiteOnboardingComplete';
      
      // ========= Centralized validation and normalization system =========
      const VALIDATION_RULES = {
        // Core validation functions
        required: v => String(v ?? '').trim().length > 0,
        phoneDigits: v => /^\d{7,15}$/.test(String(v ?? '').replace(/\D/g, '')),
        dateISO: v => /^\d{4}-\d{2}-\d{2}$/.test(String(v ?? ''))
      };
      
      // Phone normalization and formatting helpers
      function normalizePhone(raw) {
        return String(raw ?? '').replace(/\D/g, '');
      }
      
      function formatPhonePretty(digits) {
        // Keep simple, locale-agnostic pretty print. Non-destructive.
        const s = String(digits ?? '');
        if (s.length === 10) return `(${s.slice(0,3)}) ${s.slice(3,6)}-${s.slice(6)}`;
        if (s.length === 7) return `${s.slice(0,3)}-${s.slice(3)}`;
        return s;
      }
      
      // Legacy validation object for backward compatibility
      const validationRules = {
        required: (value) => {
          const trimmed = (value || '').trim();
          return {
            isValid: VALIDATION_RULES.required(value),
            message: 'This field is required'
          };
        },
        phone: (value) => {
          const cleaned = normalizePhone(value);
          return {
            isValid: VALIDATION_RULES.phoneDigits(value),
            message: 'Please enter a valid 10-digit phone number'
          };
        },
        date: (value) => {
          const trimmed = (value || '').trim();
          if (!trimmed) return { isValid: true }; // Optional field
          return {
            isValid: VALIDATION_RULES.dateISO(value),
            message: 'Please enter a valid date'
          };
        },
        select: (value) => {
          return {
            isValid: VALIDATION_RULES.required(value),
            message: 'Please select an option'
          };
        },
        minLength: (minLen) => (value) => {
          const trimmed = (value || '').trim();
          return {
            isValid: trimmed.length >= minLen,
            message: `Must be at least ${minLen} characters`
          };
        }
      };

      // Field-specific validation rules
      const FIELD_VALIDATION_RULES = {
        full_name: { required: true, minLength: 2, message: 'Full name is required' },
        dob: { required: false, type: 'date', message: 'Please enter a valid date' },
        code_status: { required: true, message: 'Code status is required' },
        ice_name: { required: true, minLength: 2, message: 'Emergency contact name is required' },
        ice_phone: { required: true, type: 'phone', message: 'Emergency contact phone is required' },
        primary_physician_name: { required: false, minLength: 2, message: 'Please enter a valid name' },
        primary_physician_phone: { required: false, type: 'phone', message: 'Please enter a valid phone number' },
        pharmacy_name: { required: false, minLength: 2, message: 'Please enter a valid pharmacy name' },
        pharmacy_phone: { required: false, type: 'phone', message: 'Please enter a valid phone number' },
        insurance_provider: { required: false, minLength: 2, message: 'Please enter a valid insurance provider' },
        insurance_phone: { required: false, type: 'phone', message: 'Please enter a valid phone number' },
        med_name: { required: true, minLength: 2, message: 'Medication name is required' },
        doc_name: { required: true, minLength: 2, message: 'Doctor\'s name is required' }
      };
      
      // Edition system configuration
      const EDITION = 'Lite'; // 'Lite' or 'Family'
      const LIMITS = {
        Lite: {
          profiles: 1,
          medications: 12,
          providers: 3,
          showGuidesTools: false
        },
        Family: {
          profiles: Infinity,
          medications: Infinity,
          providers: Infinity,
          showGuidesTools: true
        }
      };
      let medications = [];
      let careTeam = [];
      let conditions = [];
      let allergies = [];
      let lastRemoved = null;
      let toastIdCounter = 0;
      let saveStatusTimeout = null;
      let inputSaveTimeout = null;
      let lastEditTrigger = null;
      let reminderInterval = null;
      let capDialogShownThisSession = false; // Track if cap dialog was shown this session
      window.currentVisit = { reason: '', symptoms: '', questions: '', changes: '', notes: '', ts: null };
      
      // Expose functions for patch script
      window.populateFromData = populateForm;
      window.saveToLocalStorage = saveToLocalStorage;

      const sampleData = {
        full_name: 'Patricia M. Alvarez',
        dob: '1945-03-17',
        code_status: 'DNR',
        baseline_status: 'Normally alert and pleasant. Can walk with a cane. Needs help with dressing. Forgets recent events but remembers the past clearly.',
        conditions: ['Hypertension', 'Type 2 diabetes', 'Mild cognitive impairment'],
        allergies: ['Penicillin - anaphylaxis', 'Shellfish - hives'],
        preferred_hospital: "St. Mary's Medical Center",
        primary_physician_name: 'Dr. Lena Park',
        primary_physician_phone: '(312) 555-0186',
        ice_name: 'Daniel Alvarez (son)',
        ice_phone: '(773) 555-1042',
        address: '4217 W Belmont Ave, Unit 2B, Chicago, IL 60618',
        pharmacy_name: 'Lakeview Pharmacy',
        pharmacy_phone: '(773) 555-0092',
        pharmacy_after_hours_phone: '(773) 555-0093',
        pharmacy_mail_order: 'Express Scripts',
        pharmacy_mail_order_phone: '(800) 555-1234',
        insurance_provider: 'Medicare A&B + BlueCross Supplement',
        policy_number: 'BC-7845123',
        insurance_phone: '(800) 555-5678',
        insurance_group: 'GRP789',
        insurance_rx_bin: '610014',
        insurance_rx_pcn: 'N/A',
        insurance_auth_phone: '(888) 555-auth',
        policyholder_name: 'Patricia M. Alvarez',
        policyholder_rel: 'Self',
        medications: [
          { name: 'Lisinopril', dose: '10 mg', form: 'Tablet', freq: 'Every morning', purpose: 'Blood pressure', prescriber: 'Dr. Park' },
          { name: 'Metformin', dose: '500 mg', form: 'Tablet', freq: 'With breakfast & dinner', purpose: 'Blood sugar', prescriber: 'Dr. Park' },
          { name: 'Atorvastatin', dose: '20 mg', form: 'Tablet', freq: 'Nightly', purpose: 'Cholesterol', prescriber: 'Dr. Park' },
          { name: 'Vitamin D3', dose: '2000 IU', form: 'Capsule', freq: 'Once daily', purpose: 'Supplement', prescriber: 'OTC' }
        ],
        careTeam: [
            { name: 'Dr. R. Chen', specialty: 'Cardiologist', phone: '(312) 555-0200', role: 'Manages hypertension' },
            { name: 'Dr. S. Gupta', specialty: 'Neurologist', phone: '(312) 555-0300', role: 'Monitors cognitive impairment' }
        ],
        respite_routine: 'Wakes 7:30 AM, needs help to bathroom. Coffee (1 milk, 1 sugar) and oatmeal for breakfast. Likes to read newspaper until 10 AM.',
        respite_prefs: 'Loves classical music (WNYC). Favorite snack is apple slices. Always uses the blue knitted blanket in the evening.',
        respite_behavior: 'Gets anxious if TV is too loud, especially during the news. Calms down by looking at old photo albums.',
        respite_comm: 'Hard of hearing in right ear. Please face her and speak clearly. Nods even if she doesn\'t understand, so please confirm.',
        respite_practical: 'Walker for all movement. Needs help in shower (shower chair). All food must be soft or cut into small pieces.',
        visit: {
          reason: 'Routine follow-up for blood pressure and labs',
          symptoms: 'Occasional dizziness after standing; mild ankle swelling',
          questions: 'Are the current BP readings acceptable?\nShould we adjust the Metformin dose?\nAny concerns with ankle swelling?',
          changes: 'Lisinopril increased to 20mg.',
          notes: 'Follow-up in 3 months.',
          ts: null
        },
        font_size: 'default',
        paper_size: 'letter'
      };

      function escapeHtml(str) {
        return String(str || '').replace(/[&<>"']/g, function(match) {
            return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match];
        });
      }

      // Centralized clipboard copy helper
      async function copyText(text) {
        try {
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
          } else {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.setAttribute('readonly', '');
            ta.style.position = 'fixed';
            ta.style.top = '-1000px';
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
          }
          showToast({ message: 'Copied', type: 'success', duration: 1800 });
          return true;
        } catch (e) {
          console.error('Copy failed', e);
          showToast({ message: 'Copy failed', type: 'error', duration: 2500 });
          return false;
        }
      }

      // Safe DOM creation helper functions
      function createEl(tag, className) {
        const el = document.createElement(tag);
        if (className) {
          el.className = className;
        }
        return el;
      }

      function setTxt(node, text) {
        node.textContent = text;
      }

      function renderPhoneCell(value) {
        const fragment = document.createDocumentFragment();
        
        // Create phone link with normalized digits for href
        const phoneLink = createEl('a');
        const normalizedDigits = normalizePhone(value);
        phoneLink.href = normalizedDigits ? `tel:${normalizedDigits}` : '#';
        setTxt(phoneLink, normalizedDigits ? formatPhonePretty(normalizedDigits) : value);
        
        // Create copy button
        const copyBtn = createEl('button');
        copyBtn.type = 'button';
        copyBtn.className = 'copy-phone-btn';
        copyBtn.style.cssText = 'margin-left: 0.5rem; font-size: 0.8rem; padding: 0.2rem 0.4rem;';
        setTxt(copyBtn, 'Copy');
        copyBtn.setAttribute('data-action', 'copy-phone');
        copyBtn.setAttribute('data-phone', value);
        
        fragment.appendChild(phoneLink);
        fragment.appendChild(copyBtn);
        
        return fragment;
      }

      // Enhanced validation helper functions
      function validateField(el, rules) {
        // Support both element and fieldId for backward compatibility
        const field = typeof el === 'string' ? document.getElementById(el) : el;
        const fieldId = typeof el === 'string' ? el : el.id;
        const value = field ? field.value : '';
        
        // Get field-specific rules
        const fieldRules = FIELD_VALIDATION_RULES[fieldId] || {};
        
        // Apply validation rules
        for (const ruleName of rules) {
          let result;
          
          switch (ruleName) {
            case 'required':
              if (fieldRules.required) {
                result = validationRules.required(value);
                if (!result.isValid) {
                  return { isValid: false, message: fieldRules.message || result.message };
                }
              }
              break;
              
            case 'phone':
              if (fieldRules.type === 'phone') {
                result = validationRules.phone(value);
                if (!result.isValid) {
                  return { isValid: false, message: result.message };
                }
              }
              break;
              
            case 'date':
              if (fieldRules.type === 'date') {
                result = validationRules.date(value);
                if (!result.isValid) {
                  return { isValid: false, message: result.message };
                }
              }
              break;
              
            case 'select':
              if (fieldRules.type === 'select') {
                result = validationRules.select(value);
                if (!result.isValid) {
                  return { isValid: false, message: result.message };
                }
              }
              break;
              
            case 'minLength':
              if (fieldRules.minLength) {
                result = validationRules.minLength(fieldRules.minLength)(value);
                if (!result.isValid) {
                  return { isValid: false, message: fieldRules.message || result.message };
                }
              }
              break;
          }
        }
        
        return { isValid: true };
      }
      
      function showFieldError(el, message) {
        const field = typeof el === 'string' ? document.getElementById(el) : el;
        const fieldId = typeof el === 'string' ? el : el.id;
        
        if (field) {
          field.classList.add('invalid');
        }
        
        // Try to find error div
        let errorDiv = document.getElementById(`err_${fieldId}`);
        if (!errorDiv) {
          // Create error div if it doesn't exist
          errorDiv = createEl('div', 'field-error');
          errorDiv.id = `err_${fieldId}`;
          errorDiv.style.cssText = 'color: var(--danger); font-size: 0.875rem; margin-top: 0.25rem; display: block;';
          
          // Insert after the field
          if (field && field.parentNode) {
            field.parentNode.insertBefore(errorDiv, field.nextSibling);
          }
        }
        
        if (errorDiv) {
          setTxt(errorDiv, message);
          errorDiv.style.display = 'block';
        }
      }
      
      function clearFieldError(el) {
        const field = typeof el === 'string' ? document.getElementById(el) : el;
        const fieldId = typeof el === 'string' ? el : el.id;
        
        if (field) {
          field.classList.remove('invalid');
        }
        
        const errorDiv = document.getElementById(`err_${fieldId}`);
        if (errorDiv) {
          setTxt(errorDiv, '');
          errorDiv.style.display = 'none';
        }
      }
      
      // Phone number normalization helpers (legacy wrappers for backward compatibility)
      function normalizePhoneDisplay(value) {
        const digits = normalizePhone(value);
        return digits ? formatPhonePretty(digits) : value;
      }
      
      function normalizePhoneStorage(value) {
        return normalizePhone(value);
      }
      
      function formatPhoneInput(input) {
        const value = input.value;
        const cleaned = normalizePhoneStorage(value);
        
        if (cleaned && cleaned.length <= 10) {
          input.value = formatPhonePretty(cleaned);
        }
      }
      
      function validateForm() {
        let isValid = true;
        const errors = [];
        
        // Validate all fields with rules
        Object.keys(FIELD_VALIDATION_RULES).forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if (field) {
            const fieldRules = FIELD_VALIDATION_RULES[fieldId];
            const rules = [];
            
            if (fieldRules.required) rules.push('required');
            if (fieldRules.minLength) rules.push('minLength');
            if (fieldRules.type === 'phone') rules.push('phone');
            if (fieldRules.type === 'date') rules.push('date');
            if (fieldRules.type === 'select') rules.push('select');
            
            const validation = validateField(field, rules);
            if (!validation.isValid) {
              isValid = false;
              errors.push(validation.message);
              showFieldError(field, validation.message);
            } else {
              clearFieldError(field);
            }
          }
        });
        
        // Show validation summary
        const summaryDiv = document.getElementById('validation_summary');
        if (summaryDiv) {
          if (!isValid) {
            setTxt(summaryDiv, `Please fix ${errors.length} error${errors.length > 1 ? 's' : ''} before continuing.`);
            summaryDiv.style.display = 'block';
          } else {
            setTxt(summaryDiv, '');
            summaryDiv.style.display = 'none';
          }
        }
        
        return isValid;
      }
      
      function setupRealTimeValidation() {
        // Add validation to all fields with rules
        Object.keys(FIELD_VALIDATION_RULES).forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if (field) {
            const fieldRules = FIELD_VALIDATION_RULES[fieldId];
            
            // Phone field special handling
            if (fieldRules.type === 'phone') {
              // Format phone input as user types
              field.addEventListener('input', (e) => {
                formatPhoneInput(e.target);
                
                // Clear errors immediately when valid
                const rules = ['phone'];
                if (fieldRules.required) rules.push('required');
                
                const validation = validateField(field, rules);
                if (validation.isValid) {
                  clearFieldError(field);
                }
              });
              
              // Validate on blur
              field.addEventListener('blur', () => {
                const rules = ['phone'];
                if (fieldRules.required) rules.push('required');
                
                const validation = validateField(field, rules);
                if (!validation.isValid) {
                  showFieldError(field, validation.message);
                } else {
                  clearFieldError(field);
                }
              });
            } else {
              // Regular field handling
            field.addEventListener('input', () => {
                const rules = [];
                if (fieldRules.required) rules.push('required');
                if (fieldRules.minLength) rules.push('minLength');
                if (fieldRules.type === 'date') rules.push('date');
                if (fieldRules.type === 'select') rules.push('select');
                
                const validation = validateField(field, rules);
              if (validation.isValid) {
                  clearFieldError(field);
              }
            });
            
            // Validate on blur
            field.addEventListener('blur', () => {
                const rules = [];
                if (fieldRules.required) rules.push('required');
                if (fieldRules.minLength) rules.push('minLength');
                if (fieldRules.type === 'date') rules.push('date');
                if (fieldRules.type === 'select') rules.push('select');
                
                const validation = validateField(field, rules);
              if (!validation.isValid) {
                  showFieldError(field, validation.message);
              } else {
                  clearFieldError(field);
              }
            });
            }
          }
        });
      }
      
      // Immutable array helpers for predictable state updates
      function addItem(list, item) {
        return [...list, item];
      }
      
      function updateItem(list, index, patch) {
        return list.map((item, i) => i === index ? { ...item, ...patch } : item);
      }
      
      function removeItem(list, index) {
        return list.filter((_, i) => i !== index);
      }
      
      function insertItem(list, index, item) {
        return [...list.slice(0, index), item, ...list.slice(index)];
      }
      
      // Legacy function names for backward compatibility
      function addToArray(array, item) {
        return addItem(array, item);
      }
      
      function removeFromArray(array, index) {
        return removeItem(array, index);
      }
      
      function insertIntoArray(array, index, item) {
        return insertItem(array, index, item);
      }
      
      function updateArrayItem(array, index, updates) {
        return updateItem(array, index, updates);
      }
      
      // Performance utilities
      let saveTimeout = null;
      let domCache = new Map();
      
      // Debounce helper function
      function debounce(fn, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            fn(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }
      
      // Create debounced save function with 1000ms delay
      const debouncedSave = debounce(saveToLocalStorage, 1000);
      
      function immediateSave() {
        saveToLocalStorage();
      }
      
      function getCachedElement(id) {
        if (!domCache.has(id)) {
          const element = document.getElementById(id);
          if (element) {
            domCache.set(id, element);
          }
        }
        return domCache.get(id);
      }
      
      function invalidateCache() {
        domCache.clear();
      }
      
      function updateElementText(id, text) {
        const element = getCachedElement(id);
        if (element && element.textContent !== text) {
          element.textContent = text;
        }
      }
      
      function updateElementValue(id, value) {
        const element = getCachedElement(id);
        if (element && element.value !== value) {
          element.value = value;
        }
      }

      function renderPhoneCell(phone, targetElementId) {
          const container = document.getElementById(targetElementId);
          if (!container) return;
          const cleanPhone = normalizePhone(phone);
          
          // Clear container safely
          while (container.firstChild) {
              container.removeChild(container.firstChild);
          }
          
          if (!cleanPhone) {
              return;
          }
          
          // Create phone link element with normalized digits for href
          const phoneLink = document.createElement('a');
          phoneLink.href = `tel:${cleanPhone}`;
          phoneLink.textContent = cleanPhone ? formatPhonePretty(cleanPhone) : (phone || '');
          
          // Create copy button element
          const copyBtn = document.createElement('button');
          copyBtn.type = 'button';
          copyBtn.className = 'copy-btn secondary no-print';
          copyBtn.setAttribute('data-copy', phone || '');
          copyBtn.textContent = 'Copy';
          
          // Append elements to container
          container.appendChild(phoneLink);
          container.appendChild(copyBtn);
      }

      function getFormData() {
        const data = {};
        // Basics
        data.basics = {
          full_name: document.getElementById('full_name').value.trim(),
          dob: document.getElementById('dob').value.trim(),
          code_status: document.getElementById('code_status').value,
          baseline_status: document.getElementById('baseline_status').value.trim(),
          conditions: conditions,
          allergies: allergies,
          preferred_hospital: document.getElementById('preferred_hospital').value.trim()
        };
        // Contacts
        data.contacts = {
            pcp_name: document.getElementById('primary_physician_name').value.trim(),
            pcp_phone: normalizePhoneStorage(document.getElementById('primary_physician_phone').value),
            ice_name: document.getElementById('ice_name').value.trim(),
            ice_phone: normalizePhoneStorage(document.getElementById('ice_phone').value),
            ice_relation: 'N/A', // Patch schema has this, add placeholder
            address: document.getElementById('address').value.trim()
        };
        // Pharmacy & Insurance
        data.pharmacy = {
          name: document.getElementById('pharmacy_name').value.trim(),
          phone: normalizePhoneStorage(document.getElementById('pharmacy_phone').value),
          bin: document.getElementById('insurance_rx_bin').value.trim(),
          pcn: document.getElementById('insurance_rx_pcn').value.trim()
        };
        data.insurance = {
          provider: document.getElementById('insurance_provider').value.trim(),
          member_id: document.getElementById('policy_number').value.trim(),
          phone: normalizePhoneStorage(document.getElementById('insurance_phone').value),
          group: document.getElementById('insurance_group').value.trim()
        };
        // Lists
        data.medications = medications;
        data.careTeam = careTeam.map(doc => ({ ...doc, phone: normalizePhoneStorage(doc.phone) }));
        // Respite
        data.respite = {
          routine: document.getElementById('respite_routine').value.trim(),
          preferences: document.getElementById('respite_prefs').value.trim(),
          triggers: document.getElementById('respite_behavior').value.trim(),
          communication: document.getElementById('respite_comm').value.trim(),
          practical: document.getElementById('respite_practical').value.trim()
        };
        // Visit data is now a single object
        data.visit = {
            reason: document.getElementById('visit_reason').value.trim(),
            symptoms: document.getElementById('symptoms').value.trim(),
            changes: document.getElementById('visit_changes').value.trim(),
            questions: document.getElementById('questions').value.trim(),
            notes: document.getElementById('visit_notes').value.trim(),
            timestamp: (window.currentVisit && window.currentVisit.ts) ? window.currentVisit.ts : null,
        };
        // Settings
        data.settings = {
          font_size: document.getElementById('font_size').value,
          paper_size: document.getElementById('paper_size').value
        };
        return data;
      }

      function populateForm(data) {
        const d = data || {};
        const basics = d.basics || {};
        const contacts = d.contacts || {};
        const pharmacy = d.pharmacy || {};
        const insurance = d.insurance || {};
        const respite = d.respite || {};
        const visit = d.visit || {};
        const settings = d.settings || {};

        // Basics
        document.getElementById('full_name').value = basics.full_name || '';
        document.getElementById('dob').value = basics.dob || '';
        document.getElementById('code_status').value = basics.code_status || '';
        document.getElementById('baseline_status').value = basics.baseline_status || '';
        document.getElementById('preferred_hospital').value = basics.preferred_hospital || '';
        // Contacts
        document.getElementById('primary_physician_name').value = contacts.pcp_name || '';
        document.getElementById('primary_physician_phone').value = normalizePhoneDisplay(contacts.pcp_phone || '');
        document.getElementById('ice_name').value = contacts.ice_name || '';
        document.getElementById('ice_phone').value = normalizePhoneDisplay(contacts.ice_phone || '');
        document.getElementById('address').value = contacts.address || '';
        // Pharmacy & Insurance
        document.getElementById('pharmacy_name').value = pharmacy.name || '';
        document.getElementById('pharmacy_phone').value = normalizePhoneDisplay(pharmacy.phone || '');
        document.getElementById('insurance_rx_bin').value = pharmacy.bin || '';
        document.getElementById('insurance_rx_pcn').value = pharmacy.pcn || '';
        document.getElementById('insurance_provider').value = insurance.provider || '';
        document.getElementById('policy_number').value = insurance.member_id || '';
        document.getElementById('insurance_phone').value = normalizePhoneDisplay(insurance.phone || '');
        document.getElementById('insurance_group').value = insurance.group || '';
        
        // Lists - set data but don't render yet
        conditions = (basics.conditions && Array.isArray(basics.conditions)) ? basics.conditions : [];
        allergies = (basics.allergies && Array.isArray(basics.allergies)) ? basics.allergies : [];
        medications = (d.medications && Array.isArray(d.medications)) ? d.medications : [];
        careTeam = (d.careTeam && Array.isArray(d.careTeam)) ? d.careTeam.map(doc => ({ ...doc, phone: normalizePhoneDisplay(doc.phone) })) : [];
        
        // Render lists immediately for normal usage
        renderSimpleList('conditions', conditions);
        renderSimpleList('allergies', allergies);
        renderMedList();
        renderCareTeamList();
        
        // Set up real-time validation
        setupRealTimeValidation();
        // Respite
        document.getElementById('respite_routine').value = respite.routine || '';
        document.getElementById('respite_prefs').value = respite.preferences || '';
        document.getElementById('respite_behavior').value = respite.triggers || '';
        document.getElementById('respite_comm').value = respite.communication || '';
        document.getElementById('respite_practical').value = respite.practical || '';
        // Visit section
        window.currentVisit = visit || { reason: '', symptoms: '', questions: '', changes: '', notes: '', ts: null };
        document.getElementById('visit_reason').value = visit.reason || '';
        document.getElementById('symptoms').value = visit.symptoms || '';
        document.getElementById('questions').value = visit.questions || '';
        document.getElementById('visit_changes').value = visit.changes || '';
        document.getElementById('visit_notes').value = visit.notes || '';
        // Settings
        document.getElementById('font_size').value = settings.font_size || 'default';
        document.getElementById('paper_size').value = settings.paper_size || 'letter';
        
        updateAllPhoneDisplays();
        updateFontScale();
        updateSectionCompletionStatus();
        updateEmptyStates();
      }
      
      // Data-only version for profile switching (no rendering)
      function populateFormData(data) {
        const d = data || {};
        const basics = d.basics || {};
        const contacts = d.contacts || {};
        const pharmacy = d.pharmacy || {};
        const insurance = d.insurance || {};
        const respite = d.respite || {};
        const visit = d.visit || {};
        const settings = d.settings || {};

        // Basics
        document.getElementById('full_name').value = basics.full_name || '';
        document.getElementById('dob').value = basics.dob || '';
        document.getElementById('code_status').value = basics.code_status || '';
        document.getElementById('baseline_status').value = basics.baseline_status || '';
        document.getElementById('preferred_hospital').value = basics.preferred_hospital || '';
        // Contacts
        document.getElementById('primary_physician_name').value = contacts.pcp_name || '';
        document.getElementById('primary_physician_phone').value = normalizePhoneDisplay(contacts.pcp_phone || '');
        document.getElementById('ice_name').value = contacts.ice_name || '';
        document.getElementById('ice_phone').value = normalizePhoneDisplay(contacts.ice_phone || '');
        document.getElementById('address').value = contacts.address || '';
        // Pharmacy & Insurance
        document.getElementById('pharmacy_name').value = pharmacy.name || '';
        document.getElementById('pharmacy_phone').value = normalizePhoneDisplay(pharmacy.phone || '');
        document.getElementById('insurance_rx_bin').value = pharmacy.bin || '';
        document.getElementById('insurance_rx_pcn').value = pharmacy.pcn || '';
        document.getElementById('insurance_provider').value = insurance.provider || '';
        document.getElementById('policy_number').value = insurance.member_id || '';
        document.getElementById('insurance_phone').value = normalizePhoneDisplay(insurance.phone || '');
        document.getElementById('insurance_group').value = insurance.group || '';
        
        // Lists - set data only, no rendering
        conditions = (basics.conditions && Array.isArray(basics.conditions)) ? basics.conditions : [];
        allergies = (basics.allergies && Array.isArray(basics.allergies)) ? basics.allergies : [];
        medications = (d.medications && Array.isArray(d.medications)) ? d.medications : [];
        careTeam = (d.careTeam && Array.isArray(d.careTeam)) ? d.careTeam.map(doc => ({ ...doc, phone: normalizePhoneDisplay(doc.phone) })) : [];
        
        // Respite
        document.getElementById('respite_routine').value = respite.routine || '';
        document.getElementById('respite_prefs').value = respite.preferences || '';
        document.getElementById('respite_behavior').value = respite.triggers || '';
        document.getElementById('respite_comm').value = respite.communication || '';
        document.getElementById('respite_practical').value = respite.practical || '';
        // Visit section
        window.currentVisit = visit || { reason: '', symptoms: '', questions: '', changes: '', notes: '', ts: null };
        document.getElementById('visit_reason').value = visit.reason || '';
        document.getElementById('symptoms').value = visit.symptoms || '';
        document.getElementById('questions').value = visit.questions || '';
        document.getElementById('visit_changes').value = visit.changes || '';
        document.getElementById('visit_notes').value = visit.notes || '';
        // Settings
        document.getElementById('font_size').value = settings.font_size || 'default';
        document.getElementById('paper_size').value = settings.paper_size || 'letter';
      }

      function showSaveStatus() {
        const statusEl = document.getElementById('save-status');
        const live = document.getElementById('live-region');
        if (saveStatusTimeout) clearTimeout(saveStatusTimeout);
        statusEl.classList.add('visible');
        live.textContent = 'Saved';
        saveStatusTimeout = setTimeout(() => {
            statusEl.classList.remove('visible');
            live.textContent = '';
        }, 1500);

        const note = document.getElementById('local-save-note');
        if (note) note.style.display = 'block';
      }
      
      function updateFontScale() {
        const val = document.getElementById('font_size').value;
        let scale = 1.125;
        if (val === 'small') scale = 1.0;
        if (val === 'large') scale = 1.25;
        document.documentElement.style.setProperty('--font-scale', scale.toString());
      }

      function updateEmptyStates() {
          const conditionsList = document.querySelector('#conditions-list-display');
          const allergiesList = document.querySelector('#allergies-list-display');
          const medsList = document.querySelector('#meds-list-display');
          const docsList = document.querySelector('#docs-list-display');

          if(conditionsList) conditionsList.querySelector('.empty-state-enhanced').style.display = conditions.length > 0 ? 'none' : 'block';
          if(allergiesList) allergiesList.querySelector('.empty-state-enhanced').style.display = allergies.length > 0 ? 'none' : 'block';
          if(medsList) medsList.querySelector('.empty-state-enhanced').style.display = medications.length > 0 ? 'none' : 'block';
          if(docsList) docsList.querySelector('.empty-state-enhanced').style.display = careTeam.length > 0 ? 'none' : 'block';
      }

      function getCompletionPercent() {
        const data = getFormData();
        let total = 5, score = 0;
        if (data.basics.full_name && data.basics.code_status) score++;
        if (data.contacts.ice_name && data.contacts.ice_phone) score++;
        if (Array.isArray(medications) && medications.length) score++;
        if (Array.isArray(careTeam) && careTeam.length) score++;
        if (data.pharmacy.name || data.insurance.provider) score++;
        return Math.round((score/total)*100);
      }

      function updateOverallProgress() {
        const pct = getCompletionPercent();
        const bar = document.getElementById('overall-progress-bar');
        if (bar) bar.style.width = pct + '%';
      }
      
      function celebrateCompletion(sectionId) {
        const messages = {
          'basics': '🎉 Basic info complete! You\'re building a safety net.',
          'contacts-ice': '👍 Emergency contact added! First responders can now reach your loved ones.',
          'meds': '💊 First medication tracked! This helps prevent dangerous drug interactions.',
          'care_team': '👨‍⚕️ Care team member added! Coordination just got easier.',
          'contacts-other': '📋 Insurance info saved! One less thing to worry about in an emergency.'
        };

        showToast({
          message: messages[sectionId] || 'Section complete!',
          type: 'success',
          duration: 5000
        });
      }

      function updateSectionCompletionStatus(shouldCelebrate = false) {
        const sections = [
          { id: 'basics', check: () => getFormData().basics.full_name && getFormData().basics.code_status },
          { id: 'contacts-ice', check: () => getFormData().contacts.ice_name && getFormData().contacts.ice_phone },
          { id: 'meds', check: () => medications.length > 0 },
          { id: 'care_team', check: () => careTeam.length > 0 },
          { id: 'contacts-other', check: () => getFormData().pharmacy.name || getFormData().insurance.provider }
        ];

        sections.forEach(section => {
          const indicator = document.getElementById(`ind-${section.id}`);
          if(!indicator) return;
          const wasComplete = indicator.classList.contains('complete');
          const isComplete = section.check();
              
          indicator.classList.toggle('complete', isComplete);
              
          if (!wasComplete && isComplete && shouldCelebrate) {
            celebrateCompletion(section.id);
          }
        });
            
        updateOverallProgress();
      }

      function saveToLocalStorage() {
        try {
            const data = getFormData();
            const dataString = JSON.stringify(data);
            localStorage.setItem(LOCAL_STORAGE_KEY, dataString);
            showSaveStatus();
            updateSectionCompletionStatus(true); // This will now enable celebrations
            updateEmptyStates();
            updateQuickStart();
        } catch (e) {
            console.warn('Could not save to localStorage', e);
            handleLocalStorageError(e, 'save');
        }
      }
      
      // Promise-wrapped version for async operations
      function saveToLocalStorageAsync() {
        return new Promise((resolve) => {
          try {
            const data = getFormData();
            const dataString = JSON.stringify(data);
            localStorage.setItem(LOCAL_STORAGE_KEY, dataString);
            showSaveStatus();
            updateSectionCompletionStatus(true);
            updateEmptyStates();
            updateQuickStart();
            // Use setTimeout to ensure the save operation completes before resolving
            setTimeout(resolve, 0);
          } catch (e) {
            console.warn('Could not save to localStorage', e);
            handleLocalStorageError(e, 'save');
            setTimeout(resolve, 0); // Still resolve to prevent hanging
          }
        });
      }
      
      function handleLocalStorageError(error, operation) {
        if (error.name === 'QuotaExceededError') {
            showToast({
                message: 'Storage full',
                type: 'error',
                duration: 10000,
                actions: [
                    {
                        label: 'Download Backup',
                        callback: () => handleDownloadBackup()
                    },
                    {
                        label: 'Clear Old Data',
                        callback: () => clearOldData()
                    }
                ]
            });
        } else {
            showToast({
                message: 'Save failed',
                type: 'error',
                duration: 5000,
                actions: [
                    {
                        label: 'Download Backup',
                        callback: () => handleDownloadBackup()
                    }
                ]
            });
        }
      }
      
      function handleDownloadBackup() {
        try {
            const data = getFormData();
            const dataString = JSON.stringify(data, null, 2);
            const blob = new Blob([dataString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `eldercare-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast({
                message: 'Backup downloaded successfully.',
                type: 'success',
                duration: 3000
            });
        } catch (e) {
            console.error('Could not create backup', e);
            showToast({
                message: 'Could not create backup. Please try again.',
                type: 'error',
                duration: 5000
            });
        }
      }
      
      function clearOldData() {
        showToast({
            message: 'Clearing old data to free up space...',
            type: 'info',
            duration: 3000
        });
        
        try {
            // Clear old medication reminders (keep only last 30 days)
            const reminders = JSON.parse(localStorage.getItem('medicationReminders') || '[]');
            const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
            const filteredReminders = reminders.filter(reminder => {
                const reminderDate = new Date(reminder.id.split('_')[0]);
                return reminderDate.getTime() > thirtyDaysAgo;
            });
            localStorage.setItem('medicationReminders', JSON.stringify(filteredReminders));
            
            // Clear old session storage
            sessionStorage.clear();
            
            showToast({
                message: 'Old data cleared. Try saving again.',
                type: 'success',
                duration: 3000
            });
            
            // Retry save
            setTimeout(() => saveToLocalStorage(), 1000);
        } catch (e) {
            console.error('Could not clear old data', e);
            showToast({
                message: 'Could not clear old data. Please download backup and refresh.',
                type: 'error',
                duration: 5000
            });
        }
      }
      
      function updateAllPhoneDisplays() {
          renderPhoneCell(document.getElementById('ice_phone').value, 'ice_phone_display');
          renderPhoneCell(document.getElementById('primary_physician_phone').value, 'primary_physician_phone_display');
          renderPhoneCell(document.getElementById('pharmacy_phone').value, 'pharmacy_phone_display');
          renderPhoneCell(document.getElementById('insurance_phone').value, 'insurance_phone_display');
          renderPhoneCell(document.getElementById('insurance_auth_phone').value, 'insurance_auth_phone_display');
          renderPhoneCell(document.getElementById('pharmacy_after_hours_phone').value, 'pharmacy_after_hours_phone_display');
          renderPhoneCell(document.getElementById('pharmacy_mail_order_phone').value, 'pharmacy_mail_order_phone_display');
      }

      function loadFromLocalStorage() {
        try {
            const dataStr = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (dataStr) {
                const data = JSON.parse(dataStr);
                populateForm(data);
                document.getElementById('live-region').textContent = 'Data restored from previous session.';
            }
        } catch (e) {
            console.warn('Could not load from localStorage', e);
            handleLocalStorageError(e, 'load');
            // Try to remove corrupted data
            try {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
            } catch (removeError) {
                console.error('Could not remove corrupted data', removeError);
            }
        }
      }

      function showToast({ message, type = 'info', duration = 5000, actions = [] }) {
          const container = document.getElementById('toast-container');
          const toastId = `toast-${toastIdCounter++}`;
          const toast = document.createElement('div');
          toast.id = toastId;
          toast.className = `toast ${type}`;
          toast.setAttribute('role', 'status');
          toast.setAttribute('aria-live', 'polite');
          
          // Create message span
          const messageSpan = document.createElement('span');
          messageSpan.textContent = message;
          
          // Create actions container if needed
          let actionsDiv = null;
          if (actions.length > 0) {
              actionsDiv = document.createElement('div');
              actions.forEach((action, index) => {
                  const actionBtn = document.createElement('button');
                  actionBtn.id = `${toastId}-action-${index}`;
                  actionBtn.type = 'button';
                  actionBtn.textContent = action.label;
                  actionsDiv.appendChild(actionBtn);
              });
          }

          // Assemble toast content
          toast.appendChild(messageSpan);
          if (actionsDiv) {
              toast.appendChild(actionsDiv);
          }
          container.appendChild(toast);
          
          actions.forEach((action, index) => {
              document.getElementById(`${toastId}-action-${index}`).addEventListener('click', () => {
                  action.callback();
                  removeToast();
              }, { once: true });
          });

          function removeToast() {
              toast.classList.remove('show');
              setTimeout(() => toast.remove(), 500);
          }

          setTimeout(() => toast.classList.add('show'), 50);

          if (duration > 0) {
              setTimeout(removeToast, duration);
          }
      }
        
      function renderSimpleList(type, dataArray) {
          const container = document.getElementById(`${type}-list-display`);
          const emptyMsg = container.querySelector('.empty-state-enhanced');

          // Clear previous items, but not the empty message
          Array.from(container.children).forEach(child => {
              if (!child.classList.contains('empty-state-enhanced')) {
                  container.removeChild(child);
              }
          });
          
          if (dataArray.length === 0) {
              if(emptyMsg) emptyMsg.style.display = 'block';
              return;
          }
          if(emptyMsg) emptyMsg.style.display = 'none';

          dataArray.forEach((item, index) => {
              const div = document.createElement('div');
              div.className = 'list-item';
              
              // Create content paragraph
              const contentP = document.createElement('p');
              contentP.className = 'list-item-content item-title';
              contentP.textContent = item;
              
              // Create actions container
              const actionsDiv = document.createElement('div');
              actionsDiv.className = 'list-item-actions no-print';
              
              // Create remove button
              const removeBtn = document.createElement('button');
              removeBtn.type = 'button';
              removeBtn.className = 'danger';
              removeBtn.setAttribute('data-action', 'remove');
              removeBtn.setAttribute('data-type', type);
              removeBtn.setAttribute('data-index', index.toString());
              removeBtn.setAttribute('aria-label', 'Remove ' + item);
              removeBtn.textContent = 'Remove';
              
              // Assemble the structure
              actionsDiv.appendChild(removeBtn);
              div.appendChild(contentP);
              div.appendChild(actionsDiv);
              container.appendChild(div);
          });
      }

      function handleAddSimpleItem(type, inputId) {
          const input = document.getElementById(inputId);
          const value = input.value.trim();
          if (!value) return;

          // Use immutable update
          if (type === 'conditions') {
              conditions = addItem(conditions, value);
              renderSimpleList(type, conditions);
          } else if (type === 'allergies') {
              allergies = addItem(allergies, value);
              renderSimpleList(type, allergies);
          } else {
              return;
          }
          
          debouncedSave();
          input.value = '';
          input.focus();
      }

      function handleRemoveSimpleItem(type, index) {
          let item;
          let updatedArray;
          
          if (type === 'conditions') {
              item = conditions[index];
              updatedArray = removeItem(conditions, index);
              conditions = updatedArray;
          } else if (type === 'allergies') {
              item = allergies[index];
              updatedArray = removeItem(allergies, index);
              allergies = updatedArray;
          } else {
              return;
          }
          
          lastRemoved = { type: type, index, item };
          
          renderSimpleList(type, updatedArray);
          debouncedSave();

          showToast({
                message: `'${item}' removed.`,
                duration: 7000,
                actions: [{
                  label: 'Undo',
                  callback: () => {
                    if (lastRemoved && lastRemoved.type === type) {
                      // Use immutable update for undo
                      if (type === 'conditions') {
                          conditions = insertItem(conditions, lastRemoved.index, lastRemoved.item);
                          renderSimpleList(type, conditions);
                      } else if (type === 'allergies') {
                          allergies = insertItem(allergies, lastRemoved.index, lastRemoved.item);
                          renderSimpleList(type, allergies);
                      }
                      debouncedSave();
                      lastRemoved = null;
                    }
                  }
                }]
            });
      }

      function renderMedList() {
        const container = document.getElementById('meds-list-display');
        const emptyMsg = container.querySelector('.empty-state-enhanced');
        
        // Clear everything except the empty message
        Array.from(container.children).forEach(child => {
            if (!child.classList.contains('empty-state-enhanced')) {
                container.removeChild(child);
            }
        });

        if (medications.length > 0) {
          if(emptyMsg) emptyMsg.style.display = 'none';
          
          // Add share button container
          const shareContainer = document.createElement('div');
          shareContainer.className = 'share-container no-print';
          shareContainer.style.cssText = 'margin-bottom: 1rem; padding: 0.5rem; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef;';
          
          const shareInnerDiv = document.createElement('div');
          shareInnerDiv.style.cssText = 'display: flex; align-items: center; gap: 0.5rem;';
          
          const shareLabel = document.createElement('span');
          shareLabel.style.fontWeight = '500';
          shareLabel.textContent = 'Share medication list:';
          
          const copyBtn = document.createElement('button');
          copyBtn.type = 'button';
          copyBtn.className = 'secondary';
          copyBtn.id = 'btn-copy-meds';
          copyBtn.style.fontSize = '0.9rem';
          copyBtn.textContent = '📋 Copy List';
          
          const shareBtn = document.createElement('button');
          shareBtn.type = 'button';
          shareBtn.className = 'secondary';
          shareBtn.id = 'btn-share-meds';
          shareBtn.style.fontSize = '0.9rem';
          shareBtn.textContent = '📤 Share';
          
          shareInnerDiv.appendChild(shareLabel);
          shareInnerDiv.appendChild(copyBtn);
          shareInnerDiv.appendChild(shareBtn);
          shareContainer.appendChild(shareInnerDiv);
          container.appendChild(shareContainer);
          
          medications.forEach((med, index) => {
              const div = document.createElement('div');
              div.className = 'list-item';
              
              // Create content container
              const contentDiv = document.createElement('div');
              contentDiv.className = 'list-item-content';
              
              // Create title paragraph
              const titleP = document.createElement('p');
              titleP.className = 'item-title';
              titleP.textContent = med.name + ' (' + med.dose + ')';
              
              // Create detail paragraph
              const detailP = document.createElement('p');
              detailP.className = 'item-detail';
              detailP.textContent = med.freq + ' - ' + med.purpose;
              
              // Create actions container
              const actionsDiv = document.createElement('div');
              actionsDiv.className = 'list-item-actions no-print';
              
              // Create edit button
              const editBtn = document.createElement('button');
              editBtn.type = 'button';
              editBtn.className = 'secondary';
              editBtn.setAttribute('data-action', 'edit');
              editBtn.setAttribute('data-type', 'med');
              editBtn.setAttribute('data-index', index.toString());
              editBtn.setAttribute('aria-label', 'Edit ' + med.name);
              editBtn.textContent = 'Edit';
              
              // Assemble the structure
              contentDiv.appendChild(titleP);
              contentDiv.appendChild(detailP);
              actionsDiv.appendChild(editBtn);
              div.appendChild(contentDiv);
              div.appendChild(actionsDiv);
              container.appendChild(div);
          });
      }
      
      // Incremental DOM update functions for medications
      function addMedicationToDOM(med, index) {
        const container = getCachedElement('meds-list-display');
        if (!container) return;
        
        const emptyMsg = container.querySelector('.empty-state-enhanced');
        if (emptyMsg) emptyMsg.style.display = 'none';
        
        // Create medication item DOM
        const div = document.createElement('div');
        div.className = 'list-item';
        div.setAttribute('data-index', index.toString());
        
        // Create content container
        const contentDiv = document.createElement('div');
        contentDiv.className = 'list-item-content';
        
        // Create title paragraph
        const titleP = document.createElement('p');
        titleP.className = 'item-title';
        titleP.textContent = med.name + ' (' + med.dose + ')';
        
        // Create detail paragraph
        const detailP = document.createElement('p');
        detailP.className = 'item-detail';
        detailP.textContent = med.freq + ' - ' + med.purpose;
        
        // Create actions container
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'list-item-actions no-print';
        
        // Create edit button
        const editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'secondary';
        editBtn.setAttribute('data-action', 'edit');
        editBtn.setAttribute('data-type', 'med');
        editBtn.setAttribute('data-index', index.toString());
        editBtn.setAttribute('aria-label', 'Edit ' + med.name);
        editBtn.textContent = 'Edit';
        
        // Assemble the structure
        contentDiv.appendChild(titleP);
        contentDiv.appendChild(detailP);
        actionsDiv.appendChild(editBtn);
        div.appendChild(contentDiv);
        div.appendChild(actionsDiv);
        
        // Insert at the correct position (after share container if it exists)
        const shareContainer = container.querySelector('.share-container');
        if (shareContainer) {
          container.insertBefore(div, shareContainer.nextSibling);
        } else {
          container.appendChild(div);
        }
      }
      
      function updateMedicationDOM(index, med) {
        const container = getCachedElement('meds-list-display');
        if (!container) return;
        
        const itemDiv = container.querySelector(`[data-index="${index}"]`);
        if (!itemDiv) return;
        
        // Update title
        const titleP = itemDiv.querySelector('.item-title');
        if (titleP) {
          titleP.textContent = med.name + ' (' + med.dose + ')';
        }
        
        // Update detail
        const detailP = itemDiv.querySelector('.item-detail');
        if (detailP) {
          detailP.textContent = med.freq + ' - ' + med.purpose;
        }
        
        // Update edit button aria-label
        const editBtn = itemDiv.querySelector('button[data-action="edit"]');
        if (editBtn) {
          editBtn.setAttribute('aria-label', 'Edit ' + med.name);
        }
      }
      
      function removeMedicationDOM(index) {
        const container = getCachedElement('meds-list-display');
        if (!container) return;
        
        const itemDiv = container.querySelector(`[data-index="${index}"]`);
        if (itemDiv) {
          itemDiv.remove();
        }
        
        // Show empty message if no medications left
        const remainingItems = container.querySelectorAll('.list-item');
        const emptyMsg = container.querySelector('.empty-state-enhanced');
        if (remainingItems.length === 0 && emptyMsg) {
          emptyMsg.style.display = 'block';
        }
      }
      
      function handleAddMed() {
        const newMed = {
            name: document.getElementById('med_name').value.trim(),
            dose: document.getElementById('med_dose').value.trim(),
            form: document.getElementById('med_form').value,
            freq: document.getElementById('med_freq').value.trim(),
            purpose: document.getElementById('med_purpose').value.trim(),
            prescriber: document.getElementById('med_prescriber').value.trim(),
            reminderEnabled: document.getElementById('med_reminder_enabled').checked,
            reminderTime: document.getElementById('med_reminder_time').value
        };

        // Validate medication name
        const medNameField = document.getElementById('med_name');
        const validation = validateField(medNameField, ['required', 'minLength']);
        if (!validation.isValid) {
            showFieldError(medNameField, validation.message);
            medNameField.focus();
            return;
        }
        clearFieldError(medNameField);

        // Handle reminder setup if enabled
        if (newMed.reminderEnabled && newMed.reminderTime) {
            setupMedicationReminder(newMed);
        }

        // Check medication limit for Lite edition
        if (EDITION === 'Lite' && medications.length >= LIMITS.Lite.medications) {
            showCapDialog('medications');
            return;
        }

        // Use immutable update
        medications = addItem(medications, newMed);
        addMedicationToDOM(newMed, medications.length - 1);
        debouncedSave();
        document.getElementById('med_name').value = '';
        document.getElementById('med_dose').value = '';
        document.getElementById('med_freq').value = '';
        document.getElementById('med_purpose').value = '';
        document.getElementById('med_prescriber').value = '';
        document.getElementById('med_reminder_enabled').checked = false;
        document.getElementById('med_reminder_time').value = '';
        document.getElementById('med_reminder_time_container').style.display = 'none';
        document.querySelector('#meds details').open = false;
        document.getElementById('med_name').focus();
      }

      function handleRemoveMed(index) {
        const item = medications[index];
        lastRemoved = { type: 'med', index, item };
        
        // Use immutable update
        medications = removeItem(medications, index);
        removeMedicationDOM(index);
        debouncedSave();
        showToast({
            message: `'${item.name}' removed.`,
            duration: 7000,
            actions: [{
              label: 'Undo',
              callback: () => {
                if (lastRemoved && lastRemoved.type === 'med') {
                  // Use immutable update for undo
                  medications = insertItem(medications, lastRemoved.index, lastRemoved.item);
                  addMedicationToDOM(lastRemoved.item, lastRemoved.index);
                  debouncedSave();
                  lastRemoved = null;
                }
              }
            }]
        });
      }

      function renderCareTeamList() {
        const container = document.getElementById('docs-list-display');
        const emptyMsg = container.querySelector('.empty-state-enhanced');

        // Clear everything except the empty message
        Array.from(container.children).forEach(child => {
            if (!child.classList.contains('empty-state-enhanced')) {
                container.removeChild(child);
            }
        });

        if (careTeam.length > 0) {
            if(emptyMsg) emptyMsg.style.display = 'none';
            
            // Add share button container
            const shareContainer = document.createElement('div');
            shareContainer.className = 'share-container no-print';
            shareContainer.style.cssText = 'margin-bottom: 1rem; padding: 0.5rem; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef;';
            
            const shareInnerDiv = document.createElement('div');
            shareInnerDiv.style.cssText = 'display: flex; align-items: center; gap: 0.5rem;';
            
            const shareLabel = document.createElement('span');
            shareLabel.style.fontWeight = '500';
            shareLabel.textContent = 'Share care team list:';
            
            const copyBtn = document.createElement('button');
            copyBtn.type = 'button';
            copyBtn.className = 'secondary';
            copyBtn.id = 'btn-copy-docs';
            copyBtn.style.fontSize = '0.9rem';
            copyBtn.textContent = '📋 Copy List';
            
            const shareBtn = document.createElement('button');
            shareBtn.type = 'button';
            shareBtn.className = 'secondary';
            shareBtn.id = 'btn-share-docs';
            shareBtn.style.fontSize = '0.9rem';
            shareBtn.textContent = '📤 Share';
            
            shareInnerDiv.appendChild(shareLabel);
            shareInnerDiv.appendChild(copyBtn);
            shareInnerDiv.appendChild(shareBtn);
            shareContainer.appendChild(shareInnerDiv);
            container.appendChild(shareContainer);
            
            careTeam.forEach((doc, index) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                
                // Create content container
                const contentDiv = document.createElement('div');
                contentDiv.className = 'list-item-content';
                
                // Create title paragraph
                const titleP = document.createElement('p');
                titleP.className = 'item-title';
                titleP.textContent = doc.name + ' (' + doc.specialty + ')';
                
                // Create detail paragraph
                const detailP = document.createElement('p');
                detailP.className = 'item-detail';
                
                // Create phone cell with copy button
                const phoneCell = renderPhoneCell(doc.phone);
                
                // Create text node for the role
                const roleText = document.createTextNode(' - ' + doc.role);
                
                detailP.appendChild(phoneCell);
                detailP.appendChild(roleText);
                
                // Create actions container
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'list-item-actions no-print';
                
                // Create edit button
                const editBtn = document.createElement('button');
                editBtn.type = 'button';
                editBtn.className = 'secondary';
                editBtn.setAttribute('data-action', 'edit');
                editBtn.setAttribute('data-type', 'doc');
                editBtn.setAttribute('data-index', index.toString());
                editBtn.setAttribute('aria-label', 'Edit ' + doc.name);
                editBtn.textContent = 'Edit';
                
                // Assemble the structure
                contentDiv.appendChild(titleP);
                contentDiv.appendChild(detailP);
                actionsDiv.appendChild(editBtn);
                div.appendChild(contentDiv);
                div.appendChild(actionsDiv);
                container.appendChild(div);
            });
      }
      
      // Incremental DOM update functions for care team
      function addCareTeamToDOM(doc, index) {
        const container = getCachedElement('docs-list-display');
        if (!container) return;
        
        const emptyMsg = container.querySelector('.empty-state-enhanced');
        if (emptyMsg) emptyMsg.style.display = 'none';
        
        // Create care team item DOM
        const div = document.createElement('div');
        div.className = 'list-item';
        div.setAttribute('data-index', index.toString());
        
        // Create content container
        const contentDiv = document.createElement('div');
        contentDiv.className = 'list-item-content';
        
        // Create title paragraph
        const titleP = document.createElement('p');
        titleP.className = 'item-title';
        titleP.textContent = doc.name + ' (' + doc.specialty + ')';
        
        // Create detail paragraph
        const detailP = document.createElement('p');
        detailP.className = 'item-detail';
        
        // Create phone cell with copy button
        const phoneCell = renderPhoneCell(doc.phone);
        
        // Create text node for the role
        const roleText = document.createTextNode(' - ' + doc.role);
        
        detailP.appendChild(phoneCell);
        detailP.appendChild(roleText);
        
        // Create actions container
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'list-item-actions no-print';
        
        // Create edit button
        const editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'secondary';
        editBtn.setAttribute('data-action', 'edit');
        editBtn.setAttribute('data-type', 'doc');
        editBtn.setAttribute('data-index', index.toString());
        editBtn.setAttribute('aria-label', 'Edit ' + doc.name);
        editBtn.textContent = 'Edit';
        
        // Assemble the structure
        contentDiv.appendChild(titleP);
        contentDiv.appendChild(detailP);
        actionsDiv.appendChild(editBtn);
        div.appendChild(contentDiv);
        div.appendChild(actionsDiv);
        
        // Insert at the correct position (after share container if it exists)
        const shareContainer = container.querySelector('.share-container');
        if (shareContainer) {
          container.insertBefore(div, shareContainer.nextSibling);
        } else {
          container.appendChild(div);
        }
      }
      
      function updateCareTeamDOM(index, doc) {
        const container = getCachedElement('docs-list-display');
        if (!container) return;
        
        const itemDiv = container.querySelector(`[data-index="${index}"]`);
        if (!itemDiv) return;
        
        // Update title
        const titleP = itemDiv.querySelector('.item-title');
        if (titleP) {
          titleP.textContent = doc.name + ' (' + doc.specialty + ')';
        }
        
        // Update detail (phone and role)
        const detailP = itemDiv.querySelector('.item-detail');
        if (detailP) {
          // Clear existing content safely
          while (detailP.firstChild) {
            detailP.removeChild(detailP.firstChild);
          }
          
          // Create phone cell with copy button
          const phoneCell = renderPhoneCell(doc.phone);
          
          // Create text node for the role
          const roleText = document.createTextNode(' - ' + doc.role);
          
          detailP.appendChild(phoneCell);
          detailP.appendChild(roleText);
        }
        
        // Update edit button aria-label
        const editBtn = itemDiv.querySelector('button[data-action="edit"]');
        if (editBtn) {
          editBtn.setAttribute('aria-label', 'Edit ' + doc.name);
        }
      }
      
      function removeCareTeamDOM(index) {
        const container = getCachedElement('docs-list-display');
        if (!container) return;
        
        const itemDiv = container.querySelector(`[data-index="${index}"]`);
        if (itemDiv) {
          itemDiv.remove();
        }
        
        // Show empty message if no care team members left
        const remainingItems = container.querySelectorAll('.list-item');
        const emptyMsg = container.querySelector('.empty-state-enhanced');
        if (remainingItems.length === 0 && emptyMsg) {
          emptyMsg.style.display = 'block';
        }
      }
      
      function handleAddDoc() {
        const name = document.getElementById('doc_name').value.trim();
        
        // Validate doctor name
        const docNameField = document.getElementById('doc_name');
        const validation = validateField(docNameField, ['required', 'minLength']);
        if (!validation.isValid) {
            showFieldError(docNameField, validation.message);
            docNameField.focus();
            return;
        }
        clearFieldError(docNameField);
        
        // Check provider limit for Lite edition
        if (EDITION === 'Lite' && careTeam.length >= LIMITS.Lite.providers) {
            showCapDialog('providers');
            return;
        }
        
        // Use immutable update
        careTeam = addItem(careTeam, {
            name: name,
            specialty: document.getElementById('doc_specialty').value.trim(),
            phone: normalizePhoneStorage(document.getElementById('doc_phone').value),
            role: document.getElementById('doc_role').value.trim()
        });
        addCareTeamToDOM(careTeam[careTeam.length - 1], careTeam.length - 1);
        debouncedSave();
        document.getElementById('doc_name').value = '';
        document.getElementById('doc_specialty').value = '';
        document.getElementById('doc_phone').value = '';
        document.getElementById('doc_role').value = '';
        document.querySelector('#care_team details').open = false;
        document.getElementById('doc_name').focus();
      }

      function handleRemoveDoc(index) {
        const item = careTeam[index];
        lastRemoved = { type: 'doc', index, item };
        
        // Use immutable update
        careTeam = removeItem(careTeam, index);
        removeCareTeamDOM(index);
        debouncedSave();
        showToast({
            message: `'${item.name}' removed.`,
            duration: 7000,
            actions: [{
              label: 'Undo',
              callback: () => {
                if (lastRemoved && lastRemoved.type === 'doc') {
                  // Use immutable update for undo
                  careTeam = insertItem(careTeam, lastRemoved.index, lastRemoved.item);
                  addCareTeamToDOM(lastRemoved.item, lastRemoved.index);
                  debouncedSave();
                  lastRemoved = null;
                }
              }
            }]
        });
      }

      function showEditModal(type, index) {
        const modalOverlay = document.getElementById('edit-modal-overlay');
        const formContainer = document.getElementById('edit-modal-form');
        const title = document.getElementById('edit-modal-title');
        const saveBtn = document.getElementById('btn-save-edit');
        const removeBtn = document.getElementById('btn-remove-from-modal');
        let item;

        // Store the element that triggered the modal for focus return
        lastEditTrigger = document.activeElement;

        saveBtn.dataset.type = type;
        saveBtn.dataset.index = index;
        removeBtn.dataset.type = type;
        removeBtn.dataset.index = index;

        // Clear form container safely
        while (formContainer.firstChild) {
          formContainer.removeChild(formContainer.firstChild);
        }

        if (type === 'med') {
            item = medications[index];
            title.textContent = 'Edit Medication: ' + item.name;
            
            // Create form row 1
            const row1 = createEl('div', 'form-row');
            
            const nameField = createEl('div', 'field');
            nameField.style.flex = '2';
            const nameLabel = createEl('label');
            nameLabel.setAttribute('for', 'edit_med_name');
            nameLabel.textContent = 'Medication Name';
            const nameInput = createEl('input');
            nameInput.id = 'edit_med_name';
            nameInput.type = 'text';
            nameInput.value = item.name;
            nameField.appendChild(nameLabel);
            nameField.appendChild(nameInput);
            
            const doseField = createEl('div', 'field');
            const doseLabel = createEl('label');
            doseLabel.setAttribute('for', 'edit_med_dose');
            doseLabel.textContent = 'Dosage / Strength';
            const doseInput = createEl('input');
            doseInput.id = 'edit_med_dose';
            doseInput.type = 'text';
            doseInput.value = item.dose;
            doseField.appendChild(doseLabel);
            doseField.appendChild(doseInput);
            
            row1.appendChild(nameField);
            row1.appendChild(doseField);
            
            // Create form row 2
            const row2 = createEl('div', 'form-row');
            
            const formField = createEl('div', 'field');
            const formLabel = createEl('label');
            formLabel.setAttribute('for', 'edit_med_form');
            formLabel.textContent = 'Form';
            const formSelect = createEl('select');
            formSelect.id = 'edit_med_form';
            
            const formOptions = ['Tablet', 'Inhaler', 'Patch', 'Drops', 'Liquid', 'Injection', 'Other'];
            formOptions.forEach(f => {
              const option = createEl('option');
              option.value = f;
              option.textContent = f === 'Tablet' ? 'Tablet / Capsule' : f;
              if (item.form === f) {
                option.selected = true;
              }
              formSelect.appendChild(option);
            });
            
            formField.appendChild(formLabel);
            formField.appendChild(formSelect);
            
            const freqField = createEl('div', 'field');
            const freqLabel = createEl('label');
            freqLabel.setAttribute('for', 'edit_med_freq');
            freqLabel.textContent = 'Frequency / Schedule';
            const freqInput = createEl('input');
            freqInput.id = 'edit_med_freq';
            freqInput.type = 'text';
            freqInput.value = item.freq;
            freqField.appendChild(freqLabel);
            freqField.appendChild(freqInput);
            
            row2.appendChild(formField);
            row2.appendChild(freqField);
            
            // Create purpose field
            const purposeField = createEl('div', 'field');
            const purposeLabel = createEl('label');
            purposeLabel.setAttribute('for', 'edit_med_purpose');
            purposeLabel.textContent = 'Purpose / Indication';
            const purposeInput = createEl('input');
            purposeInput.id = 'edit_med_purpose';
            purposeInput.type = 'text';
            purposeInput.value = item.purpose;
            purposeField.appendChild(purposeLabel);
            purposeField.appendChild(purposeInput);
            
            // Create prescriber field
            const prescriberField = createEl('div', 'field');
            const prescriberLabel = createEl('label');
            prescriberLabel.setAttribute('for', 'edit_med_prescriber');
            prescriberLabel.textContent = 'Prescribing Doctor';
            const prescriberInput = createEl('input');
            prescriberInput.id = 'edit_med_prescriber';
            prescriberInput.type = 'text';
            prescriberInput.value = item.prescriber;
            prescriberField.appendChild(prescriberLabel);
            prescriberField.appendChild(prescriberInput);
            
            // Append all fields
            formContainer.appendChild(row1);
            formContainer.appendChild(row2);
            formContainer.appendChild(purposeField);
            formContainer.appendChild(prescriberField);
            
        } else { // type === 'doc'
            item = careTeam[index];
            title.textContent = 'Edit Doctor: ' + item.name;
            
            // Create form row 1
            const row1 = createEl('div', 'form-row');
            
            const nameField = createEl('div', 'field');
            const nameLabel = createEl('label');
            nameLabel.setAttribute('for', 'edit_doc_name');
            nameLabel.textContent = 'Doctor\'s Name';
            const nameInput = createEl('input');
            nameInput.id = 'edit_doc_name';
            nameInput.type = 'text';
            nameInput.value = item.name;
            nameField.appendChild(nameLabel);
            nameField.appendChild(nameInput);
            
            const specialtyField = createEl('div', 'field');
            const specialtyLabel = createEl('label');
            specialtyLabel.setAttribute('for', 'edit_doc_specialty');
            specialtyLabel.textContent = 'Specialty';
            const specialtyInput = createEl('input');
            specialtyInput.id = 'edit_doc_specialty';
            specialtyInput.type = 'text';
            specialtyInput.value = item.specialty;
            specialtyField.appendChild(specialtyLabel);
            specialtyField.appendChild(specialtyInput);
            
            row1.appendChild(nameField);
            row1.appendChild(specialtyField);
            
            // Create form row 2
            const row2 = createEl('div', 'form-row');
            
            const phoneField = createEl('div', 'field');
            const phoneLabel = createEl('label');
            phoneLabel.setAttribute('for', 'edit_doc_phone');
            phoneLabel.textContent = 'Phone';
            const phoneInput = createEl('input');
            phoneInput.id = 'edit_doc_phone';
            phoneInput.type = 'tel';
            phoneInput.value = normalizePhoneDisplay(item.phone);
            phoneField.appendChild(phoneLabel);
            phoneField.appendChild(phoneInput);
            
            const roleField = createEl('div', 'field');
            const roleLabel = createEl('label');
            roleLabel.setAttribute('for', 'edit_doc_role');
            roleLabel.textContent = 'Role in Care';
            const roleInput = createEl('input');
            roleInput.id = 'edit_doc_role';
            roleInput.type = 'text';
            roleInput.value = item.role;
            roleField.appendChild(roleLabel);
            roleField.appendChild(roleInput);
            
            row2.appendChild(phoneField);
            row2.appendChild(roleField);
            
            // Append all fields
            formContainer.appendChild(row1);
            formContainer.appendChild(row2);
        }
        
        // Set ARIA attributes for accessibility
        modalOverlay.setAttribute('aria-modal', 'true');
        modalOverlay.setAttribute('aria-labelledby', 'edit-modal-title');
        modalOverlay.setAttribute('role', 'dialog');
        
        modalOverlay.classList.add('visible');
        
        // Focus management: trap focus within modal
        setTimeout(() => {
            const firstInput = formContainer.querySelector('input, select, textarea');
            if (firstInput) {
                firstInput.focus();
                // Set up focus trap
                setupFocusTrap(modalOverlay);
            }
        }, 100);
      }

      function hideEditModal() {
        const modalOverlay = document.getElementById('edit-modal-overlay');
        modalOverlay.classList.remove('visible');
        
        // Clear form container safely
        const formContainer = document.getElementById('edit-modal-form');
        while (formContainer.firstChild) {
            formContainer.removeChild(formContainer.firstChild);
        }
        
        // Remove ARIA attributes
        modalOverlay.removeAttribute('aria-modal');
        modalOverlay.removeAttribute('aria-labelledby');
        modalOverlay.removeAttribute('role');
        
        // Return focus to triggering element
        if (lastEditTrigger) {
            lastEditTrigger.focus();
            lastEditTrigger = null;
        }
      }

      function setupFocusTrap(modalElement) {
        const focusableElements = modalElement.querySelectorAll(
          'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        const firstFocusableElement = focusableElements[0];
        const lastFocusableElement = focusableElements[focusableElements.length - 1];

        function handleTabKey(e) {
          if (e.key === 'Tab') {
            if (e.shiftKey) {
              if (document.activeElement === firstFocusableElement) {
                lastFocusableElement.focus();
                e.preventDefault();
              }
            } else {
              if (document.activeElement === lastFocusableElement) {
                firstFocusableElement.focus();
                e.preventDefault();
              }
            }
          }
        }

        modalElement.addEventListener('keydown', handleTabKey);
        
        // Store cleanup function
        modalElement._focusTrapCleanup = () => {
          modalElement.removeEventListener('keydown', handleTabKey);
        };
      }

      function showCapDialog(type) {
        // One-time-per-session behavior: if already shown this session, don't show again
        if (capDialogShownThisSession) {
          return;
        }

        const modalOverlay = document.getElementById('edit-modal-overlay');
        const formContainer = document.getElementById('edit-modal-form');
        const title = document.getElementById('edit-modal-title');
        const saveBtn = document.getElementById('btn-save-edit');
        const removeBtn = document.getElementById('btn-remove-from-modal');

        // Configure dialog content based on type
        let dialogContent = {};
        switch (type) {
          case 'medications':
            dialogContent = {
              title: "You've reached the Free limit",
              body: "The free version saves up to 12 medications. You can edit or print anytime. To add more, upgrade to the Family Pack.",
              primaryAction: "Keep Free Version",
              secondaryAction: "See Family Pack"
            };
            break;
          case 'providers':
            dialogContent = {
              title: "You've reached the Free limit", 
              body: "The free version saves up to 3 providers. You can edit or print anytime. To add more, upgrade to the Family Pack.",
              primaryAction: "Keep Free Version",
              secondaryAction: "See Family Pack"
            };
            break;
          case 'profiles':
            dialogContent = {
              title: "You've reached the Free limit",
              body: "The free version supports 1 profile. You can edit or print anytime. To add more, upgrade to the Family Pack.",
              primaryAction: "Keep Free Version", 
              secondaryAction: "See Family Pack"
            };
            break;
          default:
            console.warn('Unknown cap dialog type:', type);
            return;
        }

        // Set up the dialog content
        title.textContent = dialogContent.title;
        
        // Create content div
        const contentDiv = document.createElement('div');
        contentDiv.style.cssText = 'padding: 1rem 0;';
        
        // Create paragraph
        const bodyP = document.createElement('p');
        bodyP.style.cssText = 'margin: 0 0 1rem 0; line-height: 1.5;';
        bodyP.textContent = dialogContent.body;
        
        contentDiv.appendChild(bodyP);
        formContainer.appendChild(contentDiv);

        // Configure buttons
        saveBtn.textContent = dialogContent.primaryAction;
        saveBtn.className = 'primary';
        saveBtn.onclick = () => {
          capDialogShownThisSession = true; // Mark as shown this session
          hideCapDialog();
        };

        removeBtn.textContent = dialogContent.secondaryAction;
        removeBtn.className = 'secondary';
        removeBtn.onclick = () => {
          // For now, just close the dialog. In future phases, this could open Family Pack info
          hideCapDialog();
        };

        // Show the modal
        modalOverlay.classList.add('visible');
        
        // Set ARIA attributes for accessibility
        modalOverlay.setAttribute('aria-modal', 'true');
        modalOverlay.setAttribute('aria-labelledby', 'edit-modal-title');
        modalOverlay.setAttribute('role', 'dialog');
        
        // Focus management
        setTimeout(() => {
          saveBtn.focus();
          // Set up focus trap
          setupFocusTrap(modalOverlay);
        }, 100);
      }

      function hideCapDialog() {
        const modalOverlay = document.getElementById('edit-modal-overlay');
        modalOverlay.classList.remove('visible');
        
        // Clear form container safely
        const formContainer = document.getElementById('edit-modal-form');
        while (formContainer.firstChild) {
            formContainer.removeChild(formContainer.firstChild);
        }
        
        // Remove ARIA attributes
        modalOverlay.removeAttribute('aria-modal');
        modalOverlay.removeAttribute('aria-labelledby');
        modalOverlay.removeAttribute('role');
        
        // Clean up focus trap
        if (modalOverlay._focusTrapCleanup) {
          modalOverlay._focusTrapCleanup();
        }
        
        // Reset button states
        const saveBtn = document.getElementById('btn-save-edit');
        const removeBtn = document.getElementById('btn-remove-from-modal');
        saveBtn.textContent = 'Save';
        saveBtn.className = 'primary';
        saveBtn.onclick = null;
        removeBtn.textContent = 'Remove';
        removeBtn.className = 'danger';
        removeBtn.onclick = null;
      }

      function hideGuidesToolsForLite() {
        // Only hide Guides & Tools features in Lite edition
        if (EDITION === 'Lite' && !LIMITS.Lite.showGuidesTools) {
          // Hide navigation items
          const guidesHeader = document.querySelector('#sidebar-nav li.nav-header');
          if (guidesHeader && guidesHeader.textContent.includes('Guides & Tools')) {
            guidesHeader.style.display = 'none';
          }
          
          const respiteNavLink = document.querySelector('#sidebar-nav a[href="#respite"]');
          if (respiteNavLink) {
            respiteNavLink.parentElement.style.display = 'none';
          }
          
          const visitNavLink = document.querySelector('#sidebar-nav a[href="#visit"]');
          if (visitNavLink) {
            visitNavLink.parentElement.style.display = 'none';
          }
          
          // Hide content sections
          const respiteSection = document.getElementById('respite');
          if (respiteSection) {
            respiteSection.style.display = 'none';
          }
          
          const visitSection = document.getElementById('visit');
          if (visitSection) {
            visitSection.style.display = 'none';
          }
          
          // Hide print buttons
          const respitePrintBtn = document.getElementById('btn-gen-respite');
          if (respitePrintBtn) {
            respitePrintBtn.style.display = 'none';
          }
          
          const visitPrintBtn = document.getElementById('btn-gen-visit-prep');
          if (visitPrintBtn) {
            visitPrintBtn.style.display = 'none';
          }
        }
        
        // Add edition information to footer
        addEditionInfo();
      }

      function addEditionInfo() {
        const editionInfoDiv = document.getElementById('edition-info');
        if (!editionInfoDiv) return;
        
        // Clear existing content
        while (editionInfoDiv.firstChild) {
            editionInfoDiv.removeChild(editionInfoDiv.firstChild);
        }
        
        if (EDITION === 'Lite') {
          // Create main info div
          const mainDiv = document.createElement('div');
          mainDiv.style.marginBottom = '0.25rem';
          
          // Create strong element for edition
          const strongEl = document.createElement('strong');
          strongEl.textContent = 'Edition: Lite';
          
          // Create span for limits
          const limitsSpan = document.createElement('span');
          limitsSpan.setAttribute('aria-label', 'Limits: 1 profile, 12 medications, 3 providers');
          limitsSpan.textContent = 'Limits: 1 profile · 12 meds · 3 providers';
          
          // Assemble main div
          mainDiv.appendChild(strongEl);
          mainDiv.appendChild(document.createTextNode(' — Same print quality • '));
          mainDiv.appendChild(limitsSpan);
          
          // Create description div
          const descDiv = document.createElement('div');
          descDiv.style.fontSize = '0.8rem';
          descDiv.style.color = 'var(--muted)';
          descDiv.textContent = 'No accounts. No cloud. Your data stays on your device.';
          
          editionInfoDiv.appendChild(mainDiv);
          editionInfoDiv.appendChild(descDiv);
        } else {
          // Family edition - show minimal info
          const descDiv = document.createElement('div');
          descDiv.style.fontSize = '0.8rem';
          descDiv.style.color = 'var(--muted)';
          descDiv.textContent = 'No accounts. No cloud. Your data stays on your device.';
          
          editionInfoDiv.appendChild(descDiv);
        }
      }

      function handleSaveEdit(type, index) {
        if (type === 'med') {
            const name = document.getElementById('edit_med_name').value.trim();
            
            // Validate medication name
            const editMedNameField = document.getElementById('edit_med_name');
            const validation = validateField(editMedNameField, ['required', 'minLength']);
            if (!validation.isValid) {
                showFieldError(editMedNameField, validation.message);
                editMedNameField.focus();
                return;
            }
            clearFieldError(editMedNameField);
            
            // Use immutable update
            medications = updateItem(medications, index, {
                name: name,
                dose: document.getElementById('edit_med_dose').value.trim(),
                form: document.getElementById('edit_med_form').value,
                freq: document.getElementById('edit_med_freq').value.trim(),
                purpose: document.getElementById('edit_med_purpose').value.trim(),
                prescriber: document.getElementById('edit_med_prescriber').value.trim()
            });
            updateMedicationDOM(index, medications[index]);
        } else { // type === 'doc'
            const name = document.getElementById('edit_doc_name').value.trim();
            
            // Validate doctor name
            const editDocNameField = document.getElementById('edit_doc_name');
            const validation = validateField(editDocNameField, ['required', 'minLength']);
            if (!validation.isValid) {
                showFieldError(editDocNameField, validation.message);
                editDocNameField.focus();
                return;
            }
            clearFieldError(editDocNameField);
            
            // Use immutable update
            careTeam = updateItem(careTeam, index, {
                name: name,
                specialty: document.getElementById('edit_doc_specialty').value.trim(),
                phone: normalizePhoneStorage(document.getElementById('edit_doc_phone').value),
                role: document.getElementById('edit_doc_role').value.trim()
            });
            updateCareTeamDOM(index, careTeam[index]);
        }
        hideEditModal();
        debouncedSave();
      }

      function handleSave() {
        const data = getFormData();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'eldercare_data.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function handleLoad() {
        const fileInput = document.getElementById('load_input');
        fileInput.value = '';
        fileInput.onchange = function () {
          const file = fileInput.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const obj = JSON.parse(e.target.result);
              populateForm(obj);
              saveToLocalStorage();
              document.getElementById('live-region').textContent = 'Data file loaded successfully.';
              showToast({ 
                message: 'Data file loaded successfully!', 
                type: 'success',
                duration: 5000
              });
            } catch (err) {
              alert('Invalid JSON file.');
              showToast({ 
                message: 'Invalid JSON file. Please check the file format.', 
                type: 'error',
                duration: 5000
              });
            }
          };
          reader.readAsText(file);
        };
        fileInput.click();
      }

      function clearVisitInfo(silent = false) {
          document.getElementById('visit_reason').value = '';
          document.getElementById('symptoms').value = '';
          document.getElementById('questions').value = '';
          document.getElementById('visit_changes').value = '';
          document.getElementById('visit_notes').value = '';
          window.currentVisit = { reason: '', symptoms: '', questions: '', changes: '', notes: '', ts: null };
          saveToLocalStorage();
          if (!silent) {
            showToast({ message: 'Visit info cleared.' });
          }
      }

      function updateQuickStart() {
        const qs = document.getElementById('quick-start'); if (!qs) return;
        const data = getFormData();
        const done = (data.contacts.ice_name && data.contacts.ice_phone) && (Array.isArray(medications) && medications.length > 0);
        qs.style.display = done ? 'none' : '';
      }
      
      function applyFocusMode() {
        const on = document.body.classList.contains('focus-mode');
        const sections = document.querySelectorAll('main > .section');
        if (!on) { 
            sections.forEach(s => s.removeAttribute('data-collapsed')); 
            return; 
        }
        
        let active = null, minDist = Infinity;
        sections.forEach(s => {
            const rect = s.getBoundingClientRect();
            const dist = Math.abs(rect.top);
            if (dist < minDist) { minDist = dist; active = s; }
        });
        
        sections.forEach(s => {
            if (s !== active) {
                s.dataset.collapsed = '1';
            } else {
                delete s.dataset.collapsed;
            }
        });
      }
      
      // --- ONBOARDING LOGIC ---
      function initializeOnboarding() {
        let currentStep = 1;
        const totalSteps = 4;

        function updateProgress() {
          const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
          document.getElementById('progressBar').style.width = progress + '%';
        }

        function showStep(stepNum) {
          document.querySelectorAll('.onboarding-container .step').forEach(step => step.classList.remove('active'));
          document.getElementById('step' + stepNum).classList.add('active');
          currentStep = stepNum;
          updateProgress();
          window.scrollTo(0, 0);
        }

        function nextStep() {
          if (currentStep < totalSteps) showStep(currentStep + 1);
        }

        function prevStep() {
          if (currentStep > 1) showStep(currentStep - 1);
        }

        function validatePhone(phone) {
          return VALIDATION_RULES.phoneDigits(phone);
        }

        function validateAndGoToNext(e) {
            const form = e.target.closest('.step').querySelector('form');
            if (!form) { nextStep(); return; }

            const inputs = form.querySelectorAll('input[required], select[required]');
            let isValid = true;
            
            inputs.forEach(input => {
                if (!input.value.trim() || (input.type === 'tel' && !validatePhone(input.value))) {
                    input.classList.add('invalid');
                    isValid = false;
                } else {
                    input.classList.remove('invalid');
                }
            });
            
            if (isValid) nextStep();
        }

        document.addEventListener('input', (e) => {
            const input = e.target;
            if (input.closest('.onboarding-container') && input.hasAttribute('required')) {
                let isValid = input.value.trim() !== '';
                if(isValid && input.type === 'tel') {
                    isValid = validatePhone(input.value);
                }
                input.classList.toggle('valid', isValid);
                input.classList.toggle('invalid', !isValid && input.value.trim().length > 0);
            }
        });

        document.getElementById('onboarding-step1-next').addEventListener('click', nextStep);
        document.getElementById('onboarding-skip').addEventListener('click', skipOnboarding);
        document.getElementById('onboarding-step2-back').addEventListener('click', prevStep);
        document.getElementById('onboarding-step3-back').addEventListener('click', prevStep);
        document.getElementById('onboarding-step2-next').addEventListener('click', validateAndGoToNext);
        document.getElementById('onboarding-step3-next').addEventListener('click', validateAndGoToNext);
        document.getElementById('onboarding-complete').addEventListener('click', completeOnboarding);

        updateProgress();
      }

      function skipOnboarding() {
        localStorage.setItem(ONBOARDING_KEY, 'true');
        document.getElementById('onboarding-container').hidden = true;
        document.body.classList.remove('onboarding-active');
        document.getElementById('main-app').hidden = false;
        initializeMainApp();
      }

      function completeOnboarding() {
        const initialData = {
          basics: {
            full_name: document.getElementById('onboarding-fullName').value,
            dob: document.getElementById('onboarding-dateOfBirth').value,
            code_status: document.getElementById('onboarding-codeStatus').value,
          },
          contacts: {
            ice_name: document.getElementById('onboarding-iceName').value,
            ice_relation: document.getElementById('onboarding-iceRelation').value,
            ice_phone: normalizePhoneStorage(document.getElementById('onboarding-icePhone').value),
          }
        };

        populateForm(initialData);
        saveToLocalStorage();
        localStorage.setItem(ONBOARDING_KEY, 'true');

        document.getElementById('onboarding-container').hidden = true;
        document.body.classList.remove('onboarding-active');
        document.getElementById('main-app').hidden = false;
        
        initializeMainApp();
      }

      function initializeMainApp() {
        loadFromLocalStorage(); 
        loadMedicationReminders(); // Load any existing medication reminders
        
        // Start reminder ticker if notifications are enabled
        if (Notification.permission === 'granted') {
          startReminderTicker();
        }
        
        // Hide Guides & Tools features in Lite edition
        hideGuidesToolsForLite();
        
        // --- Event Listeners ---
        document.getElementById('btn-sample').addEventListener('click', function () {
            const samplePatchData = {
                basics: {
                    full_name: sampleData.full_name, dob: sampleData.dob, code_status: sampleData.code_status,
                    baseline_status: sampleData.baseline_status, conditions: sampleData.conditions,
                    allergies: sampleData.allergies, preferred_hospital: sampleData.preferred_hospital
                },
                contacts: {
                    pcp_name: sampleData.primary_physician_name, pcp_phone: sampleData.primary_physician_phone,
                    ice_name: sampleData.ice_name, ice_phone: sampleData.ice_phone, ice_relation: 'Son'
                },
                pharmacy: {
                    name: sampleData.pharmacy_name, phone: sampleData.pharmacy_phone,
                    bin: sampleData.insurance_rx_bin, pcn: sampleData.insurance_rx_pcn
                },
                insurance: {
                    provider: sampleData.insurance_provider, member_id: sampleData.policy_number,
                    phone: sampleData.insurance_phone, group: sampleData.insurance_group
                },
                medications: sampleData.medications,
                careTeam: sampleData.careTeam,
                respite: {
                    routine: sampleData.respite_routine, preferences: sampleData.respite_prefs,
                    triggers: sampleData.respite_behavior, communication: sampleData.respite_comm,
                    practical: sampleData.respite_practical
                },
                visit: sampleData.visit,
                settings: { font_size: sampleData.font_size, paper_size: sampleData.paper_size }
            };
            populateForm(samplePatchData);
            saveToLocalStorage();
            document.getElementById('live-region').textContent = 'Sample data loaded.';
        });

        document.getElementById('btn-clear').addEventListener('click', function () {
          showToast({
            message: 'Clear all data? This cannot be undone and will remove everything on this device.',
            type: 'warning',
            duration: 0,
            actions: [
              { label: 'Cancel', callback: () => {} },
              { label: 'Confirm Clear', callback: () => {
                  localStorage.removeItem(LOCAL_STORAGE_KEY);
                  medications = []; careTeam = []; conditions = []; allergies = [];
                  populateForm({});
                  saveToLocalStorage();
                  document.getElementById('live-region').textContent = 'All data cleared.';
                  showToast({ 
                    message: 'All data has been permanently cleared.', 
                    type: 'success',
                    duration: 3000
                  });
                }
              }
            ]
          });
        });
        
        document.getElementById('btn-restart').addEventListener('click', function () {
          showToast({
            message: 'Start New Profile? This will permanently clear all current data and restart the app.',
            type: 'warning',
            duration: 0, // Persists until user clicks
            actions: [
              { label: 'Cancel', callback: () => {} },
              { label: 'Confirm & Restart', callback: () => {
                  localStorage.removeItem(LOCAL_STORAGE_KEY);
                  localStorage.removeItem(ONBOARDING_KEY); // Also remove the onboarding flag
                  window.location.reload();
                }
              }
            ]
          });
        });
        
        document.getElementById('btn-add-condition').addEventListener('click', () => handleAddSimpleItem('conditions', 'condition_input'));
        document.getElementById('btn-add-allergy').addEventListener('click', () => handleAddSimpleItem('allergies', 'allergy_input'));
        document.getElementById('btn-add-med').addEventListener('click', handleAddMed);
        document.getElementById('btn-add-doc').addEventListener('click', handleAddDoc);
        
        // Medication reminder checkbox handler
        document.getElementById('med_reminder_enabled').addEventListener('change', (e) => {
          const timeContainer = document.getElementById('med_reminder_time_container');
          const exportBtn = document.getElementById('btn-export-ics');
          const show = e.target.checked;
          timeContainer.style.display = show ? 'block' : 'none';
          if (exportBtn) exportBtn.style.display = show ? 'inline-block' : 'none';
        });

        document.getElementById('btn-save').addEventListener('click', handleSave);
        document.getElementById('btn-load').addEventListener('click', handleLoad);
        document.getElementById('btn-quick-print').addEventListener('click', handleQuickPrint);
        
        // .ics Export button event listener
        document.getElementById('btn-export-ics').addEventListener('click', () => {
          const currentMedDetails = {
            id: 'temp-' + Date.now(),
            name: document.getElementById('med_name').value.trim(),
            dose: document.getElementById('med_dose').value.trim(),
            freq: document.getElementById('med_freq').value.trim(),
            purpose: document.getElementById('med_purpose').value.trim(),
            reminderTime: document.getElementById('med_reminder_time').value
          };
          
          if (!currentMedDetails.name || !currentMedDetails.reminderTime) {
            showToast({ message: 'Please enter medication name and reminder time first.', type: 'warning' });
            return;
          }
          
          const icsContent = generateICS(currentMedDetails);
          if (!icsContent) {
            showToast({ message: 'Could not generate calendar file.', type: 'error' });
            return;
          }
          
          const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `medication-reminder-${currentMedDetails.name.replace(/\s+/g, '-')}.ics`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          showToast({ message: 'Calendar file downloaded!', type: 'success', duration: 3000 });
        });
        
        // Share button event listeners (using event delegation since buttons are dynamically created)
        document.addEventListener('click', async (e) => {
          if (e.target.id === 'btn-copy-meds') {
            copyMedicationsToClipboard();
          } else if (e.target.id === 'btn-share-meds') {
            shareMedications();
          } else if (e.target.id === 'btn-copy-docs') {
            copyCareTeamToClipboard();
          } else if (e.target.id === 'btn-share-docs') {
            shareCareTeam();
          } else if (e.target.getAttribute('data-action') === 'copy-phone') {
            const phone = e.target.getAttribute('data-phone');
            if (phone) {
              await copyText(phone);
            }
          }
        });
        
        document.getElementById('basics').addEventListener('click', (e) => {
            const button = e.target.closest('button[data-action="remove"]');
            if (!button) return;
            const { type, index } = button.dataset;
            if (type === 'conditions' || type === 'allergies') {
                handleRemoveSimpleItem(type, parseInt(index, 10));
            }
        });
        
        document.getElementById('meds-list-display').addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const { action, type, index } = button.dataset;
            if (type !== 'med' || action !== 'edit') return;
            lastEditTrigger = button;
            showEditModal(type, parseInt(index, 10));
        });

        document.getElementById('docs-list-display').addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const { action, type, index } = button.dataset;
            if (type !== 'doc' || action !== 'edit') return;
            lastEditTrigger = button;
            showEditModal(type, parseInt(index, 10));
        });

        document.getElementById('btn-cancel-edit').addEventListener('click', hideEditModal);
        document.getElementById('edit-modal-overlay').addEventListener('click', (e) => {
            if (e.target.id === 'edit-modal-overlay') hideEditModal();
        });

        document.getElementById('btn-save-edit').addEventListener('click', (e) => {
            const { type, index } = e.currentTarget.dataset;
            if (type && index !== undefined) {
                handleSaveEdit(type, parseInt(index, 10));
            }
        });

        document.getElementById('btn-remove-from-modal').addEventListener('click', (e) => {
            const { type, index } = e.currentTarget.dataset;
            if (type && index !== undefined) {
                hideEditModal();
                setTimeout(() => {
                    const idx = parseInt(index, 10);
                    if (type === 'med') {
                        handleRemoveMed(idx);
                    } else {
                        handleRemoveDoc(idx);
                    }
                }, 100);
            }
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('edit-modal-overlay').classList.contains('visible')) {
                // Check if it's the cap dialog or edit modal
                const title = document.getElementById('edit-modal-title').textContent;
                if (title === "You've reached the Free limit") {
                    hideCapDialog();
                } else {
                    hideEditModal();
                }
            }
        });

        document.getElementById('btn-finish-visit').addEventListener('click', () => {
            window.currentVisit.ts = new Date().toISOString();
            saveToLocalStorage();
            showToast({ message: 'Visit recorded. Generating PDF...', type: 'success' });
            document.getElementById('btn-gen-visit-prep').click();
        });
        document.getElementById('btn-clear-visit').addEventListener('click', () => clearVisitInfo(false));
        
        document.getElementById('caregiver-mode-toggle').addEventListener('change', (e) => {
          document.body.classList.toggle('readonly', e.target.checked);
          const name = document.getElementById('full_name').value.trim();
          const banner = document.getElementById('caregiver-banner');
          const target = document.getElementById('cg-name');
          if (e.target.checked && name && banner && target) {
            banner.style.display = 'block';
            target.textContent = name;
          } else if (banner) {
            banner.style.display = 'none';
          }
        });

        document.body.addEventListener('click', async e => {
            const copyBtn = e.target.closest('.copy-btn');
            if (copyBtn) {
                const textToCopy = copyBtn.dataset.copy;
                if (textToCopy) {
                  await copyText(textToCopy);
                }
            }
        });

        const allInputs = document.querySelectorAll('#main-app input, #main-app textarea, #main-app select');
        allInputs.forEach(input => {
            input.addEventListener('change', immediateSave);
            input.addEventListener('input', debouncedSave);
            if (input.type === 'tel') {
                input.addEventListener('blur', (e) => {
                    e.target.value = normalizePhoneDisplay(e.target.value);
                    updateAllPhoneDisplays();
                    immediateSave();
                });
            }
        });

        document.getElementById('font_size').addEventListener('change', updateFontScale);

        // --- New Features from Research ---
        document.getElementById('focus_mode_toggle').addEventListener('change', (e) => {
          document.body.classList.toggle('focus-mode', e.target.checked);
          applyFocusMode();
        });
        
        // Accessibility toggles
        document.getElementById('large_text_toggle').addEventListener('change', (e) => {
          document.body.classList.toggle('large-text', e.target.checked);
          localStorage.setItem('eldercareLargeText', e.target.checked ? 'true' : 'false');
          showToast({ 
            message: e.target.checked ? 'Large text mode enabled' : 'Large text mode disabled', 
            type: 'success',
            duration: 2000
          });
        });
        
        document.getElementById('high_contrast_toggle').addEventListener('change', (e) => {
          document.body.classList.toggle('high-contrast', e.target.checked);
          localStorage.setItem('eldercareHighContrast', e.target.checked ? 'true' : 'false');
          showToast({ 
            message: e.target.checked ? 'High contrast mode enabled' : 'High contrast mode disabled', 
            type: 'success',
            duration: 2000
          });
        });
        
        // Load accessibility preferences on startup
        const largeTextEnabled = localStorage.getItem('eldercareLargeText') === 'true';
        const highContrastEnabled = localStorage.getItem('eldercareHighContrast') === 'true';
        
        if (largeTextEnabled) {
          document.getElementById('large_text_toggle').checked = true;
          document.body.classList.add('large-text');
        }
        
        if (highContrastEnabled) {
          document.getElementById('high_contrast_toggle').checked = true;
          document.body.classList.add('high-contrast');
        }
        window.addEventListener('scroll', () => {
          if (document.body.classList.contains('focus-mode')) applyFocusMode();
        }, { passive: true });
        
        document.querySelector('main').addEventListener('click', (e) => {
            if (document.body.classList.contains('focus-mode') && e.target.closest('.section[data-collapsed="1"] h2')) {
                const targetSection = e.target.closest('.section');
                targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                setTimeout(applyFocusMode, 300);
            }
        });

        // --- TIER 2 UX: Validation Success Indicators ---
        // Helper functions for validation
        function isNonEmpty(el) {
          return !!(el && el.value && el.value.trim().length > 0);
        }
        function isValidPhoneValue(val) {
          if (!val) return false;
          return VALIDATION_RULES.phoneDigits(val);
        }
        function isValidDOB(el) {
          if (!el || !el.value) return false;
          const d = new Date(el.value);
          if (Number.isNaN(d.getTime())) return false;
          const now = new Date();
          return d < now;
        }
        function applyValidity(el, valid) {
          if (!el) return;
          if (valid) {
            el.classList.remove("invalid");
            el.classList.add("valid");
          } else {
            el.classList.remove("valid");
            el.classList.add("invalid");
          }
        }

        // Required text fields
        const requiredTextIds = ["full_name", "ice_name"];
        requiredTextIds.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener("blur", () => {
            const ok = isNonEmpty(el);
            applyValidity(el, ok);
          });
        });

        // Required select fields
        const requiredSelectIds = ["code_status"];
        requiredSelectIds.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          const check = () => {
            const ok = isNonEmpty(el) && !!el.value;
            applyValidity(el, ok);
          };
          el.addEventListener("blur", check);
          el.addEventListener("change", check);
        });

        // DOB (validate only if present)
        const dobEl = document.getElementById("dob");
        if (dobEl) {
          dobEl.addEventListener("blur", () => {
            const ok = !dobEl.value ? true : isValidDOB(dobEl);
            if (!dobEl.value) {
              dobEl.classList.remove("valid", "invalid");
            } else {
              applyValidity(dobEl, ok);
            }
          });
        }

        // Phone fields
        const phoneIds = ["ice_phone", "primary_physician_phone", "pharmacy_phone", "insurance_phone"];
        phoneIds.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener("blur", () => {
            if (!el.value.trim()) {
              el.classList.remove("valid", "invalid");
              return;
            }
            const ok = isValidPhoneValue(el.value);
            applyValidity(el, ok);
          });
        });
        
        // Emergency FAB logic
        document.getElementById('emergency-fab').addEventListener('click', () => {
            const data = getFormData();
            document.getElementById('emergency-ice-name').textContent = data.contacts.ice_name || 'Not set';
            const icePhoneEl = document.getElementById('emergency-ice-phone');
            icePhoneEl.textContent = data.contacts.ice_phone || '';
            icePhoneEl.href = data.contacts.ice_phone ? `tel:${normalizePhone(data.contacts.ice_phone)}` : '#';
            document.getElementById('emergency-code-status').textContent = data.basics.code_status || 'Not set';
            document.getElementById('emergency-allergies').textContent = data.basics.allergies.join(', ') || 'None known';
            document.getElementById('emergency-modal-overlay').classList.add('visible');
        });

        document.getElementById('emergency-modal-close').addEventListener('click', () => {
            document.getElementById('emergency-modal-overlay').classList.remove('visible');
        });
        document.getElementById('emergency-modal-overlay').addEventListener('click', (e) => {
            if (e.target.id === 'emergency-modal-overlay') {
                document.getElementById('emergency-modal-overlay').classList.remove('visible');
            }
        });


        // --- Initial Load ---
        updateEmptyStates();
        updateQuickStart();
        
        // Initialize profiles system
        initProfilesUI();
      }

      // ===== Profiles: local multi-profile support =====
      const LS_PROFILES_KEY = 'ee_profiles_index';    // ["Default","Mom","Dad",...]
      const LS_ACTIVE_KEY   = 'ee_active_profile';    // "Default"
      const PROFILE_PREFIX  = 'ee_profile__';         // ee_profile__Default = JSON blob

      function loadProfilesIndex() {
        try { return JSON.parse(localStorage.getItem(LS_PROFILES_KEY) || '[]'); }
        catch (_) { return []; }
      }
      function saveProfilesIndex(list) {
        try {
            localStorage.setItem(LS_PROFILES_KEY, JSON.stringify(Array.from(new Set(list))));
        } catch (e) {
            console.warn('Could not save profiles index', e);
            handleLocalStorageError(e, 'save profiles');
        }
      }
      function profileKey(name){ return PROFILE_PREFIX + name; }

      function getActiveProfileName() {
        // URL override: ?profile=Mom
        const qp = new URLSearchParams(location.search);
        if (qp.has('profile')) return qp.get('profile');
        return localStorage.getItem(LS_ACTIVE_KEY) || null;
      }
      function setActiveProfileName(name){
        try {
            localStorage.setItem(LS_ACTIVE_KEY, name);
        } catch (e) {
            console.warn('Could not save active profile', e);
            handleLocalStorageError(e, 'save active profile');
        }
      }

      function ensureAtLeastOneProfile() {
        let idx = loadProfilesIndex();
        if (idx.length === 0) {
          idx = ['Default'];
          // Migrate current in-memory form into Default
          saveCurrentFormToProfile('Default');
          saveProfilesIndex(idx);
          setActiveProfileName('Default');
        }
      }

      function saveCurrentFormToProfile(name){
        return new Promise((resolve, reject) => {
          try {
              const data = getFormData(); // <-- using existing getFormData function
              localStorage.setItem(profileKey(name), JSON.stringify(data));
              resolve();
          } catch (e) {
              console.warn('Could not save profile data', e);
              handleLocalStorageError(e, 'save profile');
              reject(e);
          }
        });
      }

      function loadProfileToForm(name){
        const raw = localStorage.getItem(profileKey(name));
        if (!raw) return false;
        try {
          const data = JSON.parse(raw);
          populateFormData(data); // Use data-only version for profile switching
          setActiveProfileName(name);
          return true;
        } catch(_) { return false; }
      }
      
      // Profile switching state management
      let isProfileSwitching = false;
      
      async function switchToProfile(name) {
        const current = getActiveProfileName();
        
        // Prevent double-loading and rapid switching
        if (current === name || isProfileSwitching) {
          return;
        }
        
        isProfileSwitching = true;
        
        // Show loading indicator
        const sel = document.getElementById('profileSelect');
        if (sel) {
          sel.disabled = true;
          sel.style.opacity = '0.6';
        }
        
        try {
          // Step 1: Save current profile data to localStorage first
          if (current && current !== name) {
            await saveCurrentFormToProfile(current);
            // Also save to main localStorage to ensure consistency
            await saveToLocalStorageAsync();
          }
          
          // Step 2: Load the new profile data
          const success = loadProfileToForm(name);
          
          if (success) {
            // Step 3: Render sections in deterministic order
            await renderAllSections();
            
            showToast({ 
              message: `Switched to profile: ${name}`, 
              type: 'success', 
              duration: 1800 
            });
          } else {
            showToast({ 
              message: `Could not load profile: ${name}`, 
              type: 'error', 
              duration: 3000 
            });
          }
        } catch (error) {
          console.error('Profile switch failed:', error);
          showToast({ 
            message: `Failed to switch to profile: ${name}`, 
            type: 'error', 
            duration: 3000 
          });
        } finally {
          // Re-enable selector and reset flag
          isProfileSwitching = false;
          if (sel) {
            sel.disabled = false;
            sel.style.opacity = '1';
          }
        }
      }
      
      // Deterministic rendering function
      async function renderAllSections() {
        return new Promise((resolve) => {
          // Use setTimeout to ensure rendering happens after DOM updates
          setTimeout(() => {
            // Render lists in order
            renderSimpleList('conditions', conditions);
            renderSimpleList('allergies', allergies);
            renderMedList();
            renderCareTeamList();
            
            // Update UI elements
            updateAllPhoneDisplays();
            updateFontScale();
            updateSectionCompletionStatus();
            updateEmptyStates();
            
            resolve();
          }, 0);
        });
      }

      function refreshProfileSelect() {
        const sel = document.getElementById('profileSelect');
        if (!sel) return;
        const list = loadProfilesIndex();
        const active = getActiveProfileName();
        
        // Clear existing options safely
        while (sel.firstChild) {
            sel.removeChild(sel.firstChild);
        }
        
        for (const name of list) {
          const opt = document.createElement('option');
          opt.value = name; 
          opt.textContent = name;
          if (name === active) opt.selected = true;
          sel.appendChild(opt);
        }
      }

      function initProfilesUI(){
        ensureAtLeastOneProfile();
        const idx = loadProfilesIndex();
        let target = getActiveProfileName();
        if (!target || !idx.includes(target)) target = idx[0];

        // Load the target profile into the form (if stored)
        loadProfileToForm(target);
        refreshProfileSelect();

        // Switcher
        const sel = document.getElementById('profileSelect');
        if (sel) {
          sel.addEventListener('change', async (e)=>{
            const name = e.target.value;
            await switchToProfile(name);
          });
        }

        // Create
        const createBtn = document.getElementById('btnCreateProfile');
        if (createBtn) {
          createBtn.addEventListener('click', async ()=>{
            const input = document.getElementById('newProfileName');
            const name = (input?.value || '').trim();
            if (!name) { alert('Enter a profile name'); return; }
            
            // Check profile limit for Lite edition
            const idx = loadProfilesIndex();
            if (EDITION === 'Lite' && idx.length >= LIMITS.Lite.profiles) {
              showCapDialog('profiles');
              return;
            }
            
            if (idx.includes(name)) { alert('Profile already exists'); return; }
            const current = getActiveProfileName();
            if (current) await saveCurrentFormToProfile(current);
            // Clone current as starting point (or clear form if preferred)
            populateForm(getFormData());
            await saveCurrentFormToProfile(name);
            idx.push(name); saveProfilesIndex(idx);
            setActiveProfileName(name);
            refreshProfileSelect();
            if (typeof showToast === 'function') {
              showToast({ message: `Created profile: ${name}`, type: 'success', duration: 1800 });
            }
          });
        }

        // Delete
        const deleteBtn = document.getElementById('btnDeleteProfile');
        if (deleteBtn) {
          deleteBtn.addEventListener('click', async ()=>{
            const sel = document.getElementById('profileSelect');
            const name = sel?.value;
            if (!name) return;
            if (!confirm(`Delete profile "${name}"? This removes local data for that profile.`)) return;
            localStorage.removeItem(profileKey(name));
            const idx = loadProfilesIndex().filter(n => n !== name);
            saveProfilesIndex(idx);
            const fallback = idx[0] || 'Default';
            if (!idx.includes(fallback)) { saveProfilesIndex([fallback]); populateForm({}); await saveCurrentFormToProfile('Default'); }
            setActiveProfileName(fallback);
            refreshProfileSelect();
            await switchToProfile(fallback);
            if (typeof showToast === 'function') {
              showToast({ message: `Deleted: ${name}`, type: 'success', duration: 1600 });
            }
          });
        }

        // Save on unload
        window.addEventListener('beforeunload', async ()=>{
          const current = getActiveProfileName();
          if (current) {
            try {
              await saveCurrentFormToProfile(current);
            } catch (e) {
              console.warn('Could not save on unload:', e);
            }
          }
        });
      }
      
      function init() {
        if (localStorage.getItem(ONBOARDING_KEY) === 'true') {
          document.getElementById('main-app').hidden = false;
          initializeMainApp();
        } else {
          document.body.classList.add('onboarding-active');
          document.getElementById('onboarding-container').hidden = false;
          initializeOnboarding();
        }
      }
      
      document.addEventListener('DOMContentLoaded', init);
    })();

    // PDF wiring + Restore banner script + TIER 2 UX: Focus Trapping
    (function() {
      // ========= Utilities =========
      function h(x) {
  const s = String(x ?? "");
  const map = {
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#39;",
  };
  return s.replace(/[&<>"']/g, c => map[c]);
}

      function fmtPhone(p){
        if(!p) return "";
        const digits = normalizePhone(p);
        const s = String(p).trim();
        // Handle international numbers (starts with +) or non-standard lengths
        if (s.startsWith("+") || !digits || (digits.length !== 10 && digits.length !== 7)) {
          return h(s);
        }
        return formatPhonePretty(digits);
      }
      function fontScaleFromCSS(){
        const cs = getComputedStyle(document.documentElement);
        const raw = cs.getPropertyValue('--font-scale').trim();
        const n = parseFloat(raw || '1');
        return isFinite(n) && n > 0 ? n : 1;
      }
      function currentPaper(){
        try {
          const data = JSON.parse(localStorage.getItem('eldercareLiteData') || '{}');
          const p = (data.settings && data.settings.paper_size) || '';
          if (/a4/i.test(p)) return 'A4';
          if (/letter/i.test(p)) return 'Letter';
        } catch(e){}
        const sel = document.querySelector('[name="paper_size"], #paper_size, select[data-paper-size]');
        if (sel && /a4/i.test(sel.value)) return 'A4';
        return 'Letter';
      }
      function loadData(){
        try { 
            const data = JSON.parse(localStorage.getItem('eldercareLiteData') || '{}');
            if (data.basics) {
                if (Array.isArray(data.basics.conditions)) {
                    data.basics.conditions = data.basics.conditions.join(', ');
                }
                if (Array.isArray(data.basics.allergies)) {
                    data.basics.allergies = data.basics.allergies.join(', ');
                }
            }
            return data;
        } catch(e){ return {}; }
      }

      // ========= Print engine (zero dependency) =========
      // Popup-free print helper using iframe to avoid browser pop-up blocking
      function openPrint(html, opts = {}) {
        const {
          title = "Print",
          paper = currentPaper(),
          fontScale = fontScaleFromCSS(),
          afterPrintRemoveMs = 800
        } = opts;

        // Gather inline styles so printed doc matches the app
        const styleTexts = Array.from(document.styleSheets).map(ss => {
          try {
            return Array.from(ss.cssRules).map(r => r.cssText).join("\n");
          } catch(e) {
            return ""; // ignore non-inline sheets, not expected in single file build
          }
        }).join("\n");

        const iframe = document.createElement("iframe");
        iframe.style.position = "fixed";
        iframe.style.right = "0";
        iframe.style.bottom = "0";
        iframe.style.width = "0";
        iframe.style.height = "0";
        iframe.style.border = "0";
        iframe.setAttribute("aria-hidden", "true");
        document.body.appendChild(iframe);

        const doc = iframe.contentDocument || iframe.contentWindow.document;
        doc.open();
        doc.write(`<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>${h(title)}</title>
<style>
${styleTexts}
:root { --font-scale: ${fontScale}; }
@page { size: ${paper}; margin: 0.5in; }
body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; font-size: ${Math.round(16 * fontScale)}px; }
@media print { html, body { height: auto; } }
</style>
</head>
<body class="print">${html}</body>
</html>`);
        doc.close();

        const tryPrint = () => {
          const win = iframe.contentWindow;
          if (!win) return;
          win.focus();
          setTimeout(() => {
            win.print();
            setTimeout(() => {
              document.body.removeChild(iframe);
            }, afterPrintRemoveMs);
          }, 0);
        };

        // onload after document.write can be flaky, provide fallback
        if (iframe.onload !== null) {
          iframe.onload = tryPrint;
        } else {
          setTimeout(tryPrint, 50);
        }
      }
      
      // Make openPrint globally accessible
      window.openPrint = openPrint;

      // ========= Builders =========
      function section(label, body){
        return `<h2>${h(label)}</h2>${body}`;
      }
      function tableKV(obj, keys){
        const rows = keys.map(k => {
          const [label, val] = Array.isArray(k) ? k : [k, k];
          const v = obj[val];
          return `<tr><th>${h(label)}</th><td>${h(v || '')}</td></tr>`;
        }).join('');
        return `<table><tbody>${rows}</tbody></table>`;
      }
      function medsTable(meds){
        if(!Array.isArray(meds) || meds.length === 0) return '<p class="muted">No medications listed.</p>';
        const head = `<tr><th>Name</th><th>Dose</th><th>Form</th><th>Frequency</th><th>Purpose</th><th>Prescriber</th></tr>`;
        const rows = meds.map(m => `<tr>
          <td>${h(m.name)}</td><td>${h(m.dose)}</td><td>${h(m.form)}</td><td>${h(m.freq)}</td><td>${h(m.purpose)}</td><td>${h(m.prescriber)}</td>
        </tr>`).join('');
        return `<table><thead>${head}</thead><tbody>${rows}</tbody></table>`;
      }
      function careTeamTable(ct){
        if(!Array.isArray(ct) || ct.length === 0) return '<p class="muted">No care team listed.</p>';
        const head = `<tr><th>Name</th><th>Specialty</th><th>Role</th><th>Phone</th></tr>`;
        const rows = ct.map(p => `<tr>
          <td>${h(p.name)}</td><td>${h(p.specialty)}</td><td>${h(p.role)}</td><td>${fmtPhone(p.phone)}</td>
        </tr>`).join('');
        return `<table><thead>${head}</thead><tbody>${rows}</tbody></table>`;
      }

      function buildFridgeSheet(d){
        const basics = d.basics || {}; const contacts = d.contacts || {}; const pharm = d.pharmacy || {}; const ins = d.insurance || {};
        const header = `<h1>Fridge Sheet</h1><p class="muted small">Print and place visibly for first responders.</p>`;
        const left = `
          ${section('Patient', tableKV(basics, [['Full name','full_name'], ['DOB','dob'], ['Code status','code_status'], ['Baseline status','baseline_status']]))}
          ${section('Conditions', `<div>${h(basics.conditions || '')}</div>`)}
          ${section('Allergies', `<div>${h(basics.allergies || '')}</div>`)}
        `;
        const right = `
          ${section('Emergency contact (ICE)', tableKV({
            'Name': contacts.ice_name,
            'Phone': fmtPhone(contacts.ice_phone),
            'Relationship': contacts.ice_relation
          }, [['Name','Name'], ['Phone','Phone'], ['Relationship','Relationship']]))}
          ${section('Primary care', tableKV({
            'Physician': contacts.pcp_name,
            'Phone': fmtPhone(contacts.pcp_phone),
            'Preferred hospital': basics.preferred_hospital
          }, [['Physician','Physician'], ['Phone','Phone'], ['Preferred hospital','Preferred hospital']]))}
          ${section('Insurance', tableKV(ins, [['Provider','provider'], ['Member ID','member_id'], ['Group','group'], ['Phone','phone']]))}
          ${section('Pharmacy', tableKV(pharm, [['Name','name'], ['Phone','phone'], ['Rx BIN','bin'], ['Rx PCN','pcn']]))}
        `;
        const cols = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:0.3in;">${left}${right}</div>`;
        return `${header}${cols}`;
      }

      function buildWalletCard(d){
        const basics = d.basics || {}; const contacts = d.contacts || {}; const content = `
          <div class="card">
            <h2 style="margin:0 0 .05in 0">Wallet Emergency Card</h2>
            <div class="small muted" style="margin:0 0 .1in 0">Carry with you</div>
            ${tableKV({
              'Name': basics.full_name,
              'DOB': basics.dob,
              'Code': basics.code_status,
              'Allergies': basics.allergies,
              'ICE': h(contacts.ice_name || '') + (contacts.ice_relation ? ` (${h(contacts.ice_relation)})` : ''),
              'ICE phone': fmtPhone(contacts.ice_phone)
            }, [['Name','Name'], ['DOB','DOB'], ['Code','Code'], ['Allergies','Allergies'], ['ICE','ICE'], ['ICE phone','ICE phone']])}
          </div>`;
        return `<div class="two-up">${content}${content}</div>`;
      }

      function buildERPacket(d){
        const basics = d.basics || {}; const contacts = d.contacts || {}; const pharm = d.pharmacy || {}; const ins = d.insurance || {};
        const meds = Array.isArray(d.medications) ? d.medications : [];
        const careTeam = Array.isArray(d.careTeam) ? d.careTeam : [];
        const header = `<h1>Emergency Room Packet</h1><p class="muted small">Hand this to intake staff on arrival</p>`;
        const core = `
          ${section('Patient summary', tableKV(basics, [['Full name','full_name'], ['DOB','dob'], ['Code status','code_status'], ['Baseline status','baseline_status'], ['Preferred hospital','preferred_hospital']]))}
          ${section('Contacts', tableKV({
            'ICE name': contacts.ice_name,
            'ICE phone': fmtPhone(contacts.ice_phone),
            'PCP': contacts.pcp_name,
            'PCP phone': fmtPhone(contacts.pcp_phone)
          }, [['ICE name','ICE name'], ['ICE phone','ICE phone'], ['PCP','PCP'], ['PCP phone','PCP phone']]))}
          ${section('Conditions', `<div>${h(basics.conditions || '')}</div>`) }
          ${section('Allergies', `<div>${h(basics.allergies || '')}</div>`) }
          ${section('Medications', medsTable(meds))}
          ${section('Care team', careTeamTable(careTeam))}
          ${section('Insurance', tableKV(ins, [['Provider','provider'], ['Member ID','member_id'], ['Group','group'], ['Phone','phone']]))}
          ${section('Pharmacy', tableKV(pharm, [['Name','name'], ['Phone','phone'], ['Rx BIN','bin'], ['Rx PCN','pcn']]))}
        `;
        return `${header}${core}`;
      }

      function buildRespiteGuide(d){
        const r = d.respite || {};
        const header = `<h1>Respite Guide</h1><p class="muted small">Quick reference for temporary caregiver</p>`;
        const body = `
          ${section('Daily routine', `<div>${h(r.routine || '')}</div>`) }
          ${section('Preferences', `<div>${h(r.preferences || '')}</div>`) }
          ${section('Triggers', `<div>${h(r.triggers || '')}</div>`) }
          ${section('Communication tips', `<div>${h(r.communication || '')}</div>`) }
          ${section('Practical care', `<div>${h(r.practical || '')}</div>`) }
        `;
        return `${header}${body}`;
      }

      function buildVisit(d){
        const v = d.visit || {}; const basics = d.basics || {};
        const header = `<h1>Doctor Visit Sheet</h1><p class="muted small">Bring to appointment</p>`;
        const top = tableKV({
          'Patient': basics.full_name,
          'DOB': basics.dob,
          'Visit time': v.timestamp || new Date().toISOString()
        }, [['Patient','Patient'], ['DOB','DOB'], ['Visit time','Visit time']]);

        const body = `
          ${section('Reason for visit', `<div>${h(v.reason || '')}</div>`) }
          ${section('Symptoms/changes since last', `<div>${h(v.symptoms || v.changes || '')}</div>`) }
          ${section('Questions for provider', `<div>${h(v.questions || '')}</div>`) }
          ${section('Notes', `<div>${h(v.notes || '')}</div>`) }
          <div class="small muted" style="margin-top: 2rem;">Signature __________________________  Date ____________</div>
        `;
        return `${header}${top}${body}`;
      }

      // ========= Event binding =========
      function handlePdf(kind){
        const d = loadData();
        const paper = currentPaper();
        if (kind === 'fridge') return openPrint(buildFridgeSheet(d), { title: 'Fridge Sheet', paper });
        if (kind === 'wallet') return openPrint(buildWalletCard(d), { title: 'Wallet Emergency Card', paper });
        if (kind === 'er')     return openPrint(buildERPacket(d), { title: 'ER Packet', paper });
        if (kind === 'respite')return openPrint(buildRespiteGuide(d), { title: 'Respite Guide', paper });
        if (kind === 'visit')  return openPrint(buildVisit(d), { title: 'Doctor Visit Sheet', paper });
      }
      
      function handleQuickPrint() {
        const d = loadData();
        const html = buildQuickEmergencySheet(d);
        
        // Use the openPrint utility function
        if (typeof openPrint === 'function') {
          openPrint(html, { title: 'Emergency Quick Sheet', paper: currentPaper() });
        } else {
          console.error("openPrint function not found. Cannot perform quick print.");
          showToast({ message: 'Error: Quick print function unavailable.', type: 'error' });
        }
      }
      
      function buildQuickEmergencySheet(d) {
        const basics = d.basics || {};
        const contacts = d.contacts || {};
        const meds = d.medications || [];
        const conditions = d.basics?.conditions || [];
        const allergies = d.basics?.allergies || [];
        
        return `
          <h1>🚨 EMERGENCY INFORMATION 🚨</h1>
          
          <div class="emergency-info">
            <h2>Patient Information</h2>
            <table>
              <tr><th>Name:</th><td>${h(basics.full_name || 'Not provided')}</td></tr>
              <tr><th>Date of Birth:</th><td>${h(basics.dob || 'Not provided')}</td></tr>
              <tr><th>Code Status:</th><td>${h(basics.code_status || 'Not provided')}</td></tr>
            </table>
          </div>
          
          <div class="emergency-info">
            <h2>Emergency Contact</h2>
            <table>
              <tr><th>ICE Contact:</th><td>${h(contacts.ice_name || 'Not provided')}</td></tr>
              <tr><th>Phone:</th><td>${h(contacts.ice_phone || 'Not provided')}</td></tr>
            </table>
          </div>
          
          <div class="emergency-info">
            <h2>Critical Allergies</h2>
            <p><strong>${allergies.length > 0 ? allergies.map(h).join(', ') : 'None known'}</strong></p>
          </div>
          
          <div class="emergency-info">
            <h2>Current Conditions</h2>
            <p><strong>${conditions.length > 0 ? conditions.map(h).join(', ') : 'None listed'}</strong></p>
          </div>
          
          <div class="emergency-info">
            <h2>Current Medications</h2>
            ${meds.length > 0 ? `
              <table>
                <tr><th>Medication</th><th>Dosage</th><th>Frequency</th></tr>
                ${meds.map(med => `
                  <tr>
                    <td>${h(med.name)}</td>
                    <td>${h(med.dose || '')}</td>
                    <td>${h(med.freq || '')}</td>
                  </tr>
                `).join('')}
              </table>
            ` : '<p><strong>No medications listed</strong></p>'}
          </div>
          
          <div style="margin-top: 30px; text-align: center; font-size: 14px; color: #666;">
            <p>Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
            <p><strong>Keep this information accessible in case of emergency</strong></p>
          </div>
        `;
      }

      document.addEventListener('click', (ev) => {
        const el = ev.target.closest('[data-pdf]');
        if (!el) return;
        const kind = el.getAttribute('data-pdf');
        if (kind) { ev.preventDefault(); handlePdf(kind); }
      });

      // ========= Notification System =========
      let notificationPermission = null;
      
      async function requestNotificationPermission() {
        if (!('Notification' in window)) {
          showToast({ message: 'Notifications are not supported in this browser.', type: 'error' });
          return false;
        }
        
        if (notificationPermission === 'granted') return true;
        
        try {
          const permission = await Notification.requestPermission();
          notificationPermission = permission;
          if (permission === 'granted') {
            showToast({ message: 'Reminders enabled! You\'ll get notifications for your medications.', type: 'success' });
            return true;
          } else {
            showToast({ message: 'Reminder notifications are disabled. You can enable them in your browser settings.', type: 'warning' });
            return false;
          }
        } catch (error) {
          showToast({ message: 'Could not request notification permission.', type: 'error' });
          return false;
        }
      }
      
      function setupMedicationReminder(med) {
        if (!med.reminderEnabled || !med.reminderTime) return;
        
        // Request permission first
        requestNotificationPermission().then(hasPermission => {
          if (!hasPermission) return;
          
          // Store reminder info in localStorage for persistence
          const reminders = JSON.parse(localStorage.getItem('medicationReminders') || '[]');
          const reminderId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          
          reminders.push({
            id: reminderId,
            medName: med.name,
            medDose: med.dose,
            medFreq: med.freq,
            time: med.reminderTime,
            enabled: true
          });
          
          localStorage.setItem('medicationReminders', JSON.stringify(reminders));
          
          // Schedule the reminder for today if time hasn't passed yet
          scheduleReminder(reminderId, med.name, med.dose, med.freq, med.reminderTime);
          
          showToast({ message: `Reminder set for ${med.name} at ${med.reminderTime}`, type: 'success' });
        });
      }
      
      function scheduleReminder(id, medName, medDose, medFreq, reminderTime) {
        const now = new Date();
        const [hours, minutes] = reminderTime.split(':').map(Number);
        const reminderDate = new Date();
        reminderDate.setHours(hours, minutes, 0, 0);
        
        // If time has passed today, schedule for tomorrow
        if (reminderDate <= now) {
          reminderDate.setDate(reminderDate.getDate() + 1);
        }
        
        const timeUntilReminder = reminderDate.getTime() - now.getTime();
        
        setTimeout(() => {
          showMedicationNotification(medName, medDose, medFreq);
          // Schedule next day's reminder
          scheduleReminder(id, medName, medDose, medFreq, reminderTime);
        }, timeUntilReminder);
      }
      
      function showMedicationNotification(medName, medDose, medFreq) {
        if (Notification.permission === 'granted') {
          const notification = new Notification(`Medication Reminder: ${medName}`, {
            body: `Time to take ${medName}${medDose ? ' (' + medDose + ')' : ''}${medFreq ? ' - ' + medFreq : ''}`,
            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23007bff"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>',
            tag: 'medication-reminder',
            requireInteraction: true
          });
          
          // Auto-close after 10 seconds
          setTimeout(() => notification.close(), 10000);
        }
      }
      
      function loadMedicationReminders() {
        const reminders = JSON.parse(localStorage.getItem('medicationReminders') || '[]');
        reminders.forEach(reminder => {
          if (reminder.enabled) {
            scheduleReminder(reminder.id, reminder.medName, reminder.medDose, reminder.medFreq, reminder.time);
          }
        });
      }

      function checkReminders() {
        if (Notification.permission !== 'granted') return; // Only run if permission granted

        const now = new Date();
        const currentHHMM = String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');

        try {
          const reminders = JSON.parse(localStorage.getItem('medicationReminders') || '[]');
          reminders.forEach(reminder => {
            if (reminder.enabled && reminder.time === currentHHMM) {
              // Check if we already notified for this med today at this time
              const lastNotifiedKey = `notified_${reminder.id}_${now.getFullYear()}-${now.getMonth()}-${now.getDate()}`;
              if (!sessionStorage.getItem(lastNotifiedKey)) {
                showMedicationNotification(reminder.medName, reminder.medDose, reminder.medFreq);
                sessionStorage.setItem(lastNotifiedKey, 'true'); // Mark as notified for today
              }
            }
          });
        } catch (e) { console.warn("Could not check reminders", e); }
      }

      function startReminderTicker() {
        if (reminderInterval) clearInterval(reminderInterval); // Clear existing interval if any
        checkReminders(); // Check immediately
        reminderInterval = setInterval(checkReminders, 30000); // Check every 30 seconds
      }

      function stopReminderTicker() {
         if (reminderInterval) clearInterval(reminderInterval);
         reminderInterval = null;
      }

      // ========= Clipboard & Share Functions =========
      async function copyMedicationsToClipboard() {
        if (medications.length === 0) {
          showToast({ message: 'No medications to copy', type: 'warning' });
          return;
        }
        
        const medText = medications.map(med => 
          `• ${med.name}${med.dose ? ' (' + med.dose + ')' : ''}${med.freq ? ' - ' + med.freq : ''}${med.purpose ? ' - ' + med.purpose : ''}`
        ).join('\n');
        
        const textToCopy = `Current Medications:\n${medText}`;
        
        await copyText(textToCopy);
      }
      
      async function copyCareTeamToClipboard() {
        if (careTeam.length === 0) {
          showToast({ message: 'No care team members to copy', type: 'warning' });
          return;
        }
        
        const teamText = careTeam.map(doc => 
          `• ${doc.name} (${doc.specialty})${doc.phone ? ' - ' + doc.phone : ''}${doc.role ? ' - ' + doc.role : ''}`
        ).join('\n');
        
        const textToCopy = `Care Team:\n${teamText}`;
        
        await copyText(textToCopy);
      }
      
      // ========= .ics Export Function =========
      function generateICS(med) {
        if (!med || !med.name || !med.reminderTime) return null;
        
        const [hours, minutes] = med.reminderTime.split(':');
        const now = new Date();
        const startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, 0);
        
        let icsString = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//EldercareEssentials//Reminder//EN
BEGIN:VEVENT
UID:${med.id || Date.now()}@eldercareessentials.lite
DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z
DTSTART;TZID=Etc/GMT:${startDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z
RRULE:FREQ=DAILY
SUMMARY:Medication Reminder: ${med.name} ${med.dose || ''}
DESCRIPTION:Time to take ${med.name}${med.dose ? ` (${med.dose})` : ''}${med.freq ? ` - ${med.freq}` : ''}. Purpose: ${med.purpose || 'N/A'}
BEGIN:VALARM
TRIGGER:-PT5M
ACTION:DISPLAY
DESCRIPTION:Reminder: ${med.name}
END:VALARM
END:VEVENT
END:VCALENDAR`;
        
        icsString = icsString.replace(/\r\n/g, '\n').replace(/\n/g, '\r\n');
        return icsString;
      }
      
      async function shareMedications() {
        if (medications.length === 0) {
          showToast({ message: 'No medications to share', type: 'warning' });
          return;
        }
        
        const medText = medications.map(med => 
          `• ${med.name}${med.dose ? ' (' + med.dose + ')' : ''}${med.freq ? ' - ' + med.freq : ''}${med.purpose ? ' - ' + med.purpose : ''}`
        ).join('\n');
        
        const shareData = {
          title: 'My Current Medications',
          text: `Current Medications:\n${medText}`,
          url: window.location.href
        };
        
        if (navigator.share) {
          try {
            await navigator.share(shareData);
            showToast({ message: 'Medication list shared!', type: 'success' });
          } catch (err) {
            if (err.name !== 'AbortError') {
              showToast({ message: 'Could not share medications', type: 'error' });
            }
          }
        } else {
          showToast({ message: 'Sharing not supported on this device', type: 'warning' });
        }
      }
      
      async function shareCareTeam() {
        if (careTeam.length === 0) {
          showToast({ message: 'No care team members to share', type: 'warning' });
          return;
        }
        
        const teamText = careTeam.map(doc => 
          `• ${doc.name} (${doc.specialty})${doc.phone ? ' - ' + doc.phone : ''}${doc.role ? ' - ' + doc.role : ''}`
        ).join('\n');
        
        const shareData = {
          title: 'My Care Team',
          text: `Care Team:\n${teamText}`,
          url: window.location.href
        };
        
        if (navigator.share) {
          try {
            await navigator.share(shareData);
            showToast({ message: 'Care team list shared!', type: 'success' });
          } catch (err) {
            if (err.name !== 'AbortError') {
              showToast({ message: 'Could not share care team', type: 'error' });
            }
          }
        } else {
          showToast({ message: 'Sharing not supported on this device', type: 'warning' });
        }
      }

      // ========= Restore banner flow =========
      function isLikelyEmptyForm(){
        const ids = ['full_name','ice_name','ice_phone','code_status'];
        let seen = 0, blanks = 0;
        ids.forEach(id => {
          const n = document.querySelector(`[name="${id}"]`) || document.getElementById(id);
          if (n) { seen++; if (!String(n.value || '').trim()) blanks++; }
        });
        if (seen === 0) return true;
        return blanks === seen;
      }
      function savedDataExists(){
        try { const raw = localStorage.getItem('eldercareLiteData'); return raw && raw.length > 5; } catch(e){ return false; }
      }
      function showRestoreBanner(){
        const b = document.getElementById('restoreBanner');
        if (b) b.hidden = false;
      }
      function hideRestoreBanner(){
        const b = document.getElementById('restoreBanner');
        if (b) b.hidden = true;
      }
      function populateFromDataFallback(d){
        if (typeof window.populateFromData === 'function') { window.populateFromData(d); return; }
        
        const map = { ...(d.basics || {}), ...(d.contacts || {}) };
        Object.entries(map).forEach(([k,v]) => {
          const el = document.querySelector(`[name="${k}"]`) || document.getElementById(k);
          if (el && v != null) {
              if (Array.isArray(v)) {
                  el.value = v.join(', ');
              } else {
                  el.value = v;
              }
          }
        });
      }

      function restoreFromLocal(){
        const d = loadData();
        populateFromDataFallback(d);
        if (typeof window.saveToLocalStorage === 'function') {
          try { window.saveToLocalStorage(); } catch(e){}
        }
        hideRestoreBanner();
        const lr = document.getElementById('liveRegion') || document.querySelector('[aria-live]');
        if (lr) lr.textContent = 'Saved information restored.';
      }

      document.addEventListener('DOMContentLoaded', () => {
        if (!localStorage.getItem('eldercareLiteSkipRestore') && savedDataExists() && isLikelyEmptyForm()) {
          showRestoreBanner();
        }
        document.getElementById('restoreYes')?.addEventListener('click', restoreFromLocal);
        document.getElementById('restoreNo')?.addEventListener('click', () => {
          localStorage.setItem('eldercareLiteSkipRestore', '1');
          hideRestoreBanner();
        });
      });
    
      /* ===========================
         TIER 2 UX: Focus Trapping for Modals
         =========================== */

      // Track active focus traps
      const _focusTrapMap = new Map();

      // Get all focusable elements within a container
      function getFocusableIn(el) {
        if (!el) return [];
        const selector = [
          "a[href]",
          "button:not([disabled])",
          "input:not([disabled])",
          "select:not([disabled])",
          "textarea:not([disabled])",
          "[tabindex]:not([tabindex='-1'])"
        ].join(",");
        const nodes = Array.from(el.querySelectorAll(selector))
          .filter(n => n.offsetParent !== null || el === n);
        return nodes;
      }

      // Activate focus trap for a modal
      function activateFocusTrap(overlayEl, triggerEl) {
        if (!overlayEl) return;
        const focusables = getFocusableIn(overlayEl);
        if (focusables.length === 0) return;

        const first = focusables[0];
        const last  = focusables[focusables.length - 1];
        
        // Tab key handler to trap focus within modal
        const handler = (e) => {
          if (e.key !== "Tab") return;
          const active = document.activeElement;
          if (e.shiftKey) {
            // Shift + Tab: if on first element, wrap to last
            if (active === first || !overlayEl.contains(active)) {
              e.preventDefault();
              last.focus();
            }
          } else {
            // Tab: if on last element, wrap to first
            if (active === last) {
              e.preventDefault();
              first.focus();
            }
          }
        };

        overlayEl.addEventListener("keydown", handler);
        // Save trap state
        _focusTrapMap.set(overlayEl, { handler, triggerEl, first, last });
        // Focus first element initially
        first.focus();
      }

      // Deactivate focus trap and return focus to trigger
      function deactivateFocusTrap(overlayEl) {
        const st = _focusTrapMap.get(overlayEl);
        if (!st) return;
        overlayEl.removeEventListener("keydown", st.handler);
        _focusTrapMap.delete(overlayEl);
        // Return focus to original trigger if possible
        if (st.triggerEl && typeof st.triggerEl.focus === "function") {
          st.triggerEl.focus();
        }
      }

      // Setup focus traps for modals
      function setupModalFocusTraps() {
        const editOverlay = document.getElementById("edit-modal-overlay");
        const emergencyOverlay = document.getElementById("emergency-modal-overlay");
        const emergencyFab = document.getElementById("emergency-fab");
        const emergencyClose = document.getElementById("emergency-modal-close");

        // Wrap showEditModal and hideEditModal functions
        function tryWrapEditModalFns() {
          if (typeof window.showEditModal === "function" && !window._wrappedShowEditModal) {
            const origShow = window.showEditModal;
            window.showEditModal = function() {
              const trigger = document.activeElement;
              const ret = origShow.apply(this, arguments);
              // If visible, activate trap
              if (editOverlay && editOverlay.classList.contains("visible")) {
                activateFocusTrap(editOverlay, trigger);
              }
              return ret;
            };
            window._wrappedShowEditModal = true;
          }
          if (typeof window.hideEditModal === "function" && !window._wrappedHideEditModal) {
            const origHide = window.hideEditModal;
            window.hideEditModal = function() {
              if (editOverlay) deactivateFocusTrap(editOverlay);
              return origHide.apply(this, arguments);
            };
            window._wrappedHideEditModal = true;
          }
        }
        // Try immediately, then once more after a tick
        tryWrapEditModalFns();
        setTimeout(tryWrapEditModalFns, 0);

        // Emergency modal handlers
        if (emergencyFab && emergencyOverlay) {
          emergencyFab.addEventListener("click", () => {
            // Give existing code a moment to toggle visibility, then trap
            setTimeout(() => {
              if (emergencyOverlay.classList.contains("visible")) {
                activateFocusTrap(emergencyOverlay, emergencyFab);
              }
            }, 0);
          });
        }
        if (emergencyClose && emergencyOverlay) {
          emergencyClose.addEventListener("click", () => {
            deactivateFocusTrap(emergencyOverlay);
          });
        }

        // Deactivate trap if overlays are hidden by any other means
        const observer = new MutationObserver((mutations) => {
          for (const m of mutations) {
            if (m.type === "attributes" && m.attributeName === "class") {
              const el = m.target;
              if (el.classList && !el.classList.contains("visible")) {
                deactivateFocusTrap(el);
              }
            }
          }
        });
        if (editOverlay) observer.observe(editOverlay, { attributes: true });
        if (emergencyOverlay) observer.observe(emergencyOverlay, { attributes: true });
      }

      // Initialize focus traps on DOM ready
      document.addEventListener("DOMContentLoaded", function() {
        setupModalFocusTraps();
      });
})();
  </script>

  <!-- CTA Bar Helper -->
  <script>
(function(){
  if (window.installCtaBar) return; // prevent duplicates
  function el(tag, attrs, children){
    var n = document.createElement(tag);
    if(attrs){ for(var k in attrs){ if(k === 'style'){ for(var s in attrs.style){ n.style[s] = attrs.style[s]; } } else if(k.startsWith('on') && typeof attrs[k] === 'function'){ n.addEventListener(k.substring(2), attrs[k]); } else { n.setAttribute(k, attrs[k]); } } }
    (children||[]).forEach(function(c){ n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c); });
    return n;
  }
  function prefersDark(){ return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; }
  function installCtaBar(opts){
    opts = opts || {}; var gum = opts.gumroadUrl || '#'; var lite = opts.liteUrl || '#';
    var bar = el('div', { role:'region', 'aria-label':'Support and Pro Pack', style:{
      position:'fixed', left:'0', right:'0', bottom:'0', zIndex:'9999',
      display:'flex', gap:'12px', alignItems:'center', justifyContent:'space-between',
      padding:'10px 14px', borderTop:'1px solid',
      backdropFilter:'saturate(140%) blur(6px)', WebkitBackdropFilter:'saturate(140%) blur(6px)'
    }});
    var dark = prefersDark();
    bar.style.background = dark ? 'rgba(18,18,20,0.7)' : 'rgba(255,255,255,0.8)';
    bar.style.borderTopColor = dark ? 'rgba(255,255,255,0.12)' : 'rgba(0,0,0,0.1)';
    var label = el('div', { style:{ fontFamily:'system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif', fontSize:'14px', lineHeight:'1.2' }}, [
      el('strong', null, ['Need templates or a quick start? ']),
      'Get the Family Pro Pack'
    ]);
    var btnRow = el('div', { style:{ display:'flex', gap:'8px' }}, []);
    function mkBtn(txt, primary){
      var b = el('a', { href:'#', target:'_blank', rel:'noopener', role:'button' }, [txt]);
      b.style.fontFamily = 'system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif';
      b.style.fontSize = '14px';
      b.style.padding = '8px 12px';
      b.style.borderRadius = '10px';
      b.style.textDecoration = 'none';
      b.style.border = '1px solid';
      if(primary){
        b.style.background = '#16a34a';
        b.style.color = '#fff';
        b.style.borderColor = '#12843c';
      } else {
        b.style.background = dark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.04)';
        b.style.color = dark ? '#ffffff' : '#111827';
        b.style.borderColor = dark ? 'rgba(255,255,255,0.18)' : 'rgba(0,0,0,0.12)';
      }
      b.addEventListener('keydown', function(e){ if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); b.click(); } });
      return b;
    }
    var pro = mkBtn('Support & Pro Pack', true);  pro.href = gum;
    var free = mkBtn('Free Lite', false);          free.href = lite;
    btnRow.appendChild(free); btnRow.appendChild(pro);
    bar.appendChild(label); bar.appendChild(btnRow);
    document.addEventListener('keydown', function (e) {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'b') {
        bar.hidden = !bar.hidden;
      }
    });
    if(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches){ bar.style.transition = 'none'; }
    else { bar.style.transition = 'transform .18s ease, opacity .18s ease'; }
    document.body.appendChild(bar);
  }
  window.installCtaBar = installCtaBar;
  }
})();
  </script>

  <!-- CTA Bar Initializer -->
  <script>
    window.installCtaBar({
      gumroadUrl: '{{GUMROAD_URL}}',
      liteUrl: '{{LITE_URL}}'
    });
  </script>
</body>
</html>